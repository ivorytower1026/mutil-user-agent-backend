# v0.1.9 测试用例

## 一、后端测试

### 1.1 中断显示优化测试

**测试文件**: `tests/test_interrupt_display.py`

```python
import pytest
from src.agent_manager import AgentManager

def test_format_interrupt_info_execute():
    """测试 execute 工具的中断信息格式化"""
    am = AgentManager()
    
    # 短命令
    request = {"name": "execute", "args": {"command": "ls"}}
    assert am._format_interrupt_info(request) == "正在执行命令: ls"
    
    # 长命令（超过30字符）
    request = {"name": "execute", "args": {"command": "npm install --save-dev @types/node @types/react"}}
    result = am._format_interrupt_info(request)
    assert "正在执行命令:" in result
    assert "..." in result

def test_format_interrupt_info_write_file():
    """测试 write_file 工具的中断信息格式化"""
    am = AgentManager()
    
    request = {"name": "write_file", "args": {"file_path": "/workspace/test.py"}}
    assert am._format_interrupt_info(request) == "正在写入文件: test.py"
    
    request = {"name": "write_file", "args": {"file_path": "/workspace/src/components/Button.tsx"}}
    assert am._format_interrupt_info(request) == "正在写入文件: Button.tsx"

def test_format_interrupt_info_ask_user():
    """测试 ask_user 工具的中断信息格式化"""
    am = AgentManager()
    
    request = {"name": "ask_user", "args": {"questions": [{}]}}
    assert am._format_interrupt_info(request) == "Agent 提出了 1 个问题"
    
    request = {"name": "ask_user", "args": {"questions": [{}, {}, {}]}}
    assert am._format_interrupt_info(request) == "Agent 提出了 3 个问题"

def test_get_task_display_name():
    """测试工具名中文转换"""
    am = AgentManager()
    
    assert am._get_task_display_name("execute") == "执行命令"
    assert am._get_task_display_name("write_file") == "写入文件"
    assert am._get_task_display_name("ask_user") == "用户问答"
    assert am._get_task_display_name("unknown") == "unknown"
```

### 1.2 ask_user 工具测试

**测试文件**: `tests/test_ask_user_tool.py`

```python
import pytest
import json
from src.agent_manager import AgentManager

@pytest.mark.asyncio
async def test_ask_user_tool_without_answers():
    """测试 ask_user 工具在没有答案时返回等待消息"""
    am = AgentManager()
    tool = am._create_ask_user_tool()
    
    questions = [
        {"question": "你喜欢什么颜色?", "options": [{"label": "红色", "value": "red"}]}
    ]
    
    result = tool.invoke({"questions": questions})
    assert result == "Waiting for user response..."

@pytest.mark.asyncio
async def test_ask_user_tool_with_answers():
    """测试 ask_user 工具在有答案时返回答案"""
    am = AgentManager()
    tool = am._create_ask_user_tool()
    
    questions = [
        {"question": "你喜欢什么颜色?", "options": [{"label": "红色", "value": "red"}]},
        {"question": "你喜欢什么动物?", "options": [{"label": "狗", "value": "dog"}]}
    ]
    answers = ["red", "cat"]
    
    result = tool.invoke({"questions": questions, "answers": answers})
    assert json.loads(result) == ["red", "cat"]
```

### 1.3 API 测试

**测试文件**: `tests/test_resume_api.py`

```python
import pytest
import requests
import json

BASE_URL = "http://localhost:8002"

def test_resume_with_answers():
    """测试带答案的恢复请求"""
    # 1. 创建会话
    login_res = requests.post(f"{BASE_URL}/api/auth/login", json={
        "username": "test_user",
        "password": "test_password"
    })
    token = login_res.json()["access_token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    session_res = requests.post(f"{BASE_URL}/api/sessions", headers=headers)
    thread_id = session_res.json()["thread_id"]
    
    # 2. 发送消息触发 ask_user 中断
    chat_res = requests.post(
        f"{BASE_URL}/api/chat/{thread_id}",
        headers=headers,
        json={"message": "请问我一些问题"},
        stream=True
    )
    
    # 收集 SSE 事件
    interrupt_received = False
    for line in chat_res.iter_lines():
        if line:
            line = line.decode('utf-8')
            if line.startswith('data:'):
                data = json.loads(line[5:])
                if data.get('taskName') == '用户问答':
                    interrupt_received = True
                    questions = data.get('questions', [])
                    break
    
    assert interrupt_received, "Should receive interrupt"
    
    # 3. 发送答案恢复
    answers = ["red", "dog", "now"]
    resume_res = requests.post(
        f"{BASE_URL}/api/resume/{thread_id}",
        headers=headers,
        json={"action": "answer", "answers": answers},
        stream=True
    )
    
    assert resume_res.status_code == 200

def test_resume_without_answers_when_action_is_answer():
    """测试 action=answer 但没有 answers 时应返回 400"""
    login_res = requests.post(f"{BASE_URL}/api/auth/login", json={
        "username": "test_user",
        "password": "test_password"
    })
    token = login_res.json()["access_token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    session_res = requests.post(f"{BASE_URL}/api/sessions", headers=headers)
    thread_id = session_res.json()["thread_id"]
    
    resume_res = requests.post(
        f"{BASE_URL}/api/resume/{thread_id}",
        headers=headers,
        json={"action": "answer"}  # 没有 answers
    )
    
    assert resume_res.status_code == 400
```

---

## 二、前端测试

### 2.1 类型测试

**测试文件**: `src/types/__tests__/chat.test.ts`

```typescript
import { describe, it, expect } from 'vitest'
import type { Question, QuestionOption, Interrupt } from '../chat'

describe('Question types', () => {
  it('should define QuestionOption correctly', () => {
    const option: QuestionOption = {
      label: '红色',
      value: 'red',
      allow_custom: false
    }
    expect(option.label).toBe('红色')
    expect(option.value).toBe('red')
  })

  it('should define Question with custom option', () => {
    const question: Question = {
      question: '你喜欢什么颜色?',
      options: [
        { label: '红色', value: 'red' },
        { label: '自定义', value: '__custom__', allow_custom: true }
      ]
    }
    expect(question.options.length).toBe(2)
    expect(question.options[1].allow_custom).toBe(true)
  })

  it('should define Interrupt with questions', () => {
    const interrupt: Interrupt = {
      taskName: '用户问答',
      info: 'Agent 提出了 3 个问题',
      questions: [
        { question: '问题1', options: [] },
        { question: '问题2', options: [] },
        { question: '问题3', options: [] }
      ]
    }
    expect(interrupt.questions?.length).toBe(3)
  })
})
```

### 2.2 组件测试

**测试文件**: `src/components/interrupt/__tests__/InterruptDetail.test.ts`

```typescript
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import InterruptDetail from '../InterruptDetail.vue'
import type { Interrupt } from '@/types/chat'

describe('InterruptDetail', () => {
  it('should render normal options when no questions', () => {
    const interrupt: Interrupt = {
      taskName: '执行命令',
      info: '正在执行命令: ls',
      options: [
        { id: 'continue', label: '继续执行' },
        { id: 'cancel', label: '取消执行' }
      ]
    }
    
    const wrapper = mount(InterruptDetail, {
      props: { interrupt }
    })
    
    expect(wrapper.text()).toContain('正在执行命令: ls')
    expect(wrapper.text()).toContain('继续执行')
    expect(wrapper.text()).toContain('取消执行')
  })

  it('should render questions when provided', () => {
    const interrupt: Interrupt = {
      taskName: '用户问答',
      info: 'Agent 提出了 2 个问题',
      questions: [
        { 
          question: '你喜欢什么颜色?', 
          options: [
            { label: '红色', value: 'red' },
            { label: '绿色', value: 'green' }
          ] 
        },
        { 
          question: '你喜欢什么动物?', 
          options: [
            { label: '狗', value: 'dog' },
            { label: '猫', value: 'cat' }
          ] 
        }
      ]
    }
    
    const wrapper = mount(InterruptDetail, {
      props: { interrupt }
    })
    
    expect(wrapper.text()).toContain('你喜欢什么颜色?')
    expect(wrapper.text()).toContain('你喜欢什么动物?')
    expect(wrapper.text()).toContain('红色')
    expect(wrapper.text()).toContain('狗')
  })

  it('should show custom input when custom option selected', async () => {
    const interrupt: Interrupt = {
      taskName: '用户问答',
      info: 'Agent 提出了 1 个问题',
      questions: [
        { 
          question: '你喜欢什么颜色?', 
          options: [
            { label: '红色', value: 'red' },
            { label: '自定义', value: '__custom__', allow_custom: true }
          ] 
        }
      ]
    }
    
    const wrapper = mount(InterruptDetail, {
      props: { interrupt }
    })
    
    // 初始不应显示自定义输入框
    expect(wrapper.find('.custom-input').exists()).toBe(false)
    
    // 点击自定义选项
    await wrapper.findAll('.option-card')[1].trigger('click')
    
    // 现在应该显示自定义输入框
    expect(wrapper.find('.custom-input').exists()).toBe(true)
  })
})
```

### 2.3 E2E 测试

**测试文件**: `tests/e2e/ask_user.cy.ts`

```typescript
describe('Ask User Tool', () => {
  beforeEach(() => {
    cy.login('test_user', 'test_password')
    cy.visit('/chat')
  })

  it('should display questions when agent asks', () => {
    // 发送消息触发 agent 提问
    cy.get('[data-testid="chat-input"]').type('请问我一些问题{enter}')
    
    // 等待中断出现
    cy.get('.interrupt-selector', { timeout: 10000 }).should('be.visible')
    
    // 验证问题显示
    cy.get('.question-item').should('have.length.at.least', 1)
    cy.get('.question-text').should('contain', '?')
  })

  it('should allow selecting options and submitting', () => {
    cy.get('[data-testid="chat-input"]').type('请问我一些问题{enter}')
    cy.get('.interrupt-selector', { timeout: 10000 }).should('be.visible')
    
    // 为每个问题选择选项
    cy.get('.question-item').each(($question) => {
      cy.wrap($question).find('.option-card').first().click()
    })
    
    // 点击确认
    cy.get('.interrupt-actions button').contains('确认选择').click()
    
    // 验证中断消失，聊天继续
    cy.get('.interrupt-selector').should('not.exist')
  })

  it('should show custom input when custom option selected', () => {
    cy.get('[data-testid="chat-input"]').type('请问我一些问题{enter}')
    cy.get('.interrupt-selector', { timeout: 10000 }).should('be.visible')
    
    // 找到有自定义选项的问题
    cy.get('.question-item').first().within(() => {
      // 点击最后一个选项（通常是自定义）
      cy.get('.option-card').last().click()
      
      // 应该出现输入框
      cy.get('.custom-input input').should('be.visible')
      
      // 输入自定义答案
      cy.get('.custom-input input').type('我的自定义答案')
    })
  })

  it('should disable confirm button until all questions answered', () => {
    cy.get('[data-testid="chat-input"]').type('请问我一些问题{enter}')
    cy.get('.interrupt-selector', { timeout: 10000 }).should('be.visible')
    
    // 初始状态确认按钮应该禁用
    cy.get('.interrupt-actions button').should('be.disabled')
    
    // 回答所有问题后按钮应该启用
    cy.get('.question-item').each(($question) => {
      cy.wrap($question).find('.option-card').first().click()
    })
    
    cy.get('.interrupt-actions button').should('not.be.disabled')
  })
})
```

---

## 三、集成测试

### 3.1 完整流程测试

**测试文件**: `tests/test_ask_user_integration.py`

```python
import pytest
import requests
import json

BASE_URL = "http://localhost:8002"

def test_complete_ask_user_flow():
    """测试完整的 ask_user 工具流程"""
    
    # 1. 登录
    login_res = requests.post(f"{BASE_URL}/api/auth/login", json={
        "username": "test_user",
        "password": "test_password"
    })
    assert login_res.status_code == 200
    token = login_res.json()["access_token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    # 2. 创建会话
    session_res = requests.post(f"{BASE_URL}/api/sessions", headers=headers)
    assert session_res.status_code == 200
    thread_id = session_res.json()["thread_id"]
    
    # 3. 发送消息触发 ask_user
    # 这里需要一个能触发 ask_user 的消息
    chat_res = requests.post(
        f"{BASE_URL}/api/chat/{thread_id}",
        headers=headers,
        json={"message": "帮我创建一个项目，但我需要先回答一些问题"},
        stream=True
    )
    
    # 4. 收集中断事件
    interrupt_data = None
    for line in chat_res.iter_lines():
        if line:
            line = line.decode('utf-8')
            if line.startswith('event:') and 'interrupt' in line:
                # 下一行是 data
                continue
            if line.startswith('data:'):
                data = json.loads(line[5:])
                if data.get('taskName') == '用户问答':
                    interrupt_data = data
                    break
    
    assert interrupt_data is not None, "Should receive ask_user interrupt"
    assert interrupt_data.get('questions') is not None, "Should have questions"
    
    # 5. 准备答案
    questions = interrupt_data['questions']
    answers = []
    for q in questions:
        # 选择第一个选项
        answers.append(q['options'][0]['value'])
    
    # 6. 发送答案恢复
    resume_res = requests.post(
        f"{BASE_URL}/api/resume/{thread_id}",
        headers=headers,
        json={"action": "answer", "answers": answers},
        stream=True
    )
    
    assert resume_res.status_code == 200
    
    # 7. 验证恢复后继续执行
    done_received = False
    for line in resume_res.iter_lines():
        if line:
            line = line.decode('utf-8')
            if line.startswith('event:') and 'end' in line:
                done_received = True
    
    assert done_received, "Should receive done event after resume"

def test_interrupt_display_improvement():
    """测试中断显示优化"""
    
    login_res = requests.post(f"{BASE_URL}/api/auth/login", json={
        "username": "test_user",
        "password": "test_password"
    })
    token = login_res.json()["access_token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    session_res = requests.post(f"{BASE_URL}/api/sessions", headers=headers)
    thread_id = session_res.json()["thread_id"]
    
    # 触发 execute 中断
    chat_res = requests.post(
        f"{BASE_URL}/api/chat/{thread_id}",
        headers=headers,
        json={"message": "执行命令: ls -la"},
        stream=True
    )
    
    for line in chat_res.iter_lines():
        if line:
            line = line.decode('utf-8')
            if line.startswith('data:'):
                data = json.loads(line[5:])
                if data.get('taskName') == '执行命令':
                    # 验证中文显示
                    assert '正在执行命令' in data.get('info', '')
                    break
```

---

## 四、测试执行

### 后端测试

```bash
# 运行所有测试
uv run pytest tests/ -v

# 只运行 ask_user 相关测试
uv run pytest tests/ -k "ask_user" -v

# 只运行中断显示测试
uv run pytest tests/ -k "interrupt" -v
```

### 前端测试

```bash
# 运行单元测试
npm run test

# 运行 E2E 测试
npm run test:e2e

# 运行特定测试
npm run test -- --grep "Ask User"
```

---

## 五、验收标准

| 测试项 | 预期结果 |
|--------|----------|
| execute 中断显示 | `info: "正在执行命令: xxx"` |
| write_file 中断显示 | `info: "正在写入文件: xxx.py"` |
| ask_user 中断显示 | `info: "Agent 提出了 N 个问题"` |
| 多问题渲染 | 所有问题正确显示 |
| 选项选择 | 点击选项后高亮 |
| 自定义输入 | 选择自定义后显示输入框 |
| 答案提交 | 所有答案正确传递 |
| 中断恢复 | Agent 继续执行 |
