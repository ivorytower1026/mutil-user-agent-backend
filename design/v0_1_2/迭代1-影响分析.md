# 迭代1：影响分析

## 一、影响概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                         影响范围图                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐                                               │
│  │  api/server.py   │  ◀── 新增端点                                 │
│  │  ──────────────  │                                               │
│  │  POST /sessions  │  (不变)                                       │
│  │  POST /chat/{id} │  (不变)                                       │
│  │  POST /resume/{id}│ (不变)                                       │
│  │  DELETE /sessions/{id} │ ◀── 新增                                │
│  └──────────────────┘                                               │
│           │                                                         │
│           ▼                                                         │
│  ┌──────────────────┐                                               │
│  │ agent_manager.py │  ◀── 无需修改                                 │
│  │  ──────────────  │                                               │
│  │  create_session()│  调用 get_thread_backend() - 签名不变         │
│  │  stream_chat()   │  间接使用 backend - 行为不变                  │
│  └──────────────────┘                                               │
│           │                                                         │
│           ▼                                                         │
│  ┌──────────────────┐                                               │
│  │ docker_sandbox.py│  ◀── 核心修改                                 │
│  │  ──────────────  │                                               │
│  │  get_thread_backend() │ 签名不变，新增 destroy_thread_backend()  │
│  │  DockerSandboxBackend │                                          │
│  │    - __init__()  │  新增 _container 属性                         │
│  │    - execute()   │  逻辑修改（复用容器）                          │
│  │    - destroy()   │  新增方法                                     │
│  │    - _ensure_container() │ 新增方法                              │
│  └──────────────────┘                                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、文件变更详情

### 2.1 `src/docker_sandbox.py` - 核心修改

| 位置 | 变更类型 | 说明 |
|------|---------|------|
| 第13行 `_thread_backends` | 不变 | 保持现有字典 |
| 第16行 `get_thread_backend()` | 不变 | 签名和行为保持兼容 |
| **新增** `destroy_thread_backend()` | 新增 | 销毁thread的backend和容器 |
| 第37-42行 `__init__` | 修改 | 新增 `self._container = None` |
| 第44-46行 `id` 属性 | 不变 | 保持不变 |
| **新增** `_ensure_container()` | 新增 | 懒加载容器 |
| 第48-66行 `execute()` | 修改 | 改为调用 `_ensure_container()` |
| **新增** `destroy()` | 新增 | 显式销毁容器 |
| 第68-80行 `upload/download` | 可选修改 | 实现真实的文件操作（可选） |

### 2.2 `api/server.py` - 新增端点

| 位置 | 变更类型 | 说明 |
|------|---------|------|
| 第18-25行 `POST /sessions` | 不变 | 保持不变 |
| 第28-48行 `POST /chat/{thread_id}` | 不变 | 保持不变 |
| 第51-77行 `POST /resume/{thread_id}` | 不变 | 保持不变 |
| **新增** `DELETE /sessions/{thread_id}` | 新增 | 销毁会话 |

### 2.3 `src/agent_manager.py` - 无需修改

| 位置 | 影响 | 说明 |
|------|------|------|
| 第12行 `get_thread_backend` 导入 | 无 | 导入不变 |
| 第37-39行 backend lambda | 无 | 调用方式不变 |
| 第53-64行 `create_session()` | 无 | 调用不变 |

---

## 三、API接口影响

### 3.1 现有接口 - 全部兼容

| 接口 | 方法 | 影响 | 说明 |
|------|------|------|------|
| `/api/auth/register` | POST | 无 | 认证模块 |
| `/api/auth/login` | POST | 无 | 认证模块 |
| `/api/sessions` | POST | 无 | 创建会话，行为不变 |
| `/api/chat/{thread_id}` | POST | 无 | 对话，**行为增强**（容器状态保持） |
| `/api/resume/{thread_id}` | POST | 无 | 恢复中断，行为不变 |

### 3.2 新增接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/sessions/{thread_id}` | DELETE | 销毁会话和容器 |

### 3.3 行为变化

| 场景 | 当前行为 | 改后行为 | 影响 |
|------|---------|---------|------|
| 多次execute | 每次新建容器 | 复用同一容器 | **用户体验提升** |
| pip install | 下次execute失效 | 持续有效 | **新能力** |
| 文件创建 | 下次execute消失 | 持续存在 | **新能力** |
| 会话结束 | 容器自动销毁 | 需手动调用DELETE | **需注意** |

---

## 四、调用链分析

### 4.1 创建会话流程

```
当前:                              改后:
POST /api/sessions                 POST /api/sessions
       │                                  │
       ▼                                  ▼
agent_manager.create_session()     agent_manager.create_session()
       │                                  │
       ▼                                  ▼
get_thread_backend(thread_id)      get_thread_backend(thread_id)
       │                                  │
       ▼                                  ▼
DockerSandboxBackend.__init__()    DockerSandboxBackend.__init__()
       │                                  │
       ▼                                  ▼
(无容器创建)                        _container = None (无容器创建)
```

**结论**: 无变化

### 4.2 对话流程

```
当前:                              改后:
POST /api/chat/{thread_id}         POST /api/chat/{thread_id}
       │                                  │
       ▼                                  ▼
agent_manager.stream_chat()        agent_manager.stream_chat()
       │                                  │
       ▼                                  ▼
compiled_agent.astream_events()    compiled_agent.astream_events()
       │                                  │
       ▼                                  ▼
backend.execute()                  backend.execute()
       │                                  │
       ▼                                  ▼
_create_container() + start()      _ensure_container()
       │                                  │
       ▼                                  ▼
exec_run()                         exec_run()
       │                                  │
       ▼                                  ▼
container.remove()                 (无销毁，容器保持)
```

**结论**: 行为变化，但对上层透明

### 4.3 销毁会话流程（新增）

```
DELETE /api/sessions/{thread_id}
       │
       ▼
verify_thread_permission()
       │
       ▼
destroy_thread_backend(thread_id)
       │
       ▼
backend.destroy()
       │
       ▼
container.remove(force=True)
```

---

## 五、兼容性分析

### 5.1 向后兼容

| 项目 | 兼容性 | 说明 |
|------|--------|------|
| API签名 | ✅ 完全兼容 | 现有端点签名不变 |
| 返回格式 | ✅ 完全兼容 | 返回数据格式不变 |
| 错误处理 | ✅ 完全兼容 | 异常类型不变 |
| 客户端代码 | ✅ 无需修改 | 现有调用方式完全有效 |

### 5.2 新增依赖

| 依赖 | 是否需要 | 说明 |
|------|---------|------|
| 新Python包 | 否 | 使用现有docker包 |
| 新配置项 | 否 | 使用现有配置 |
| 数据库变更 | 否 | 无数据库改动 |

---

## 六、风险点

### 6.1 潜在问题

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 容器泄漏 | 中 | 资源耗尽 | 文档提醒调用DELETE |
| 并发竞争 | 低 | 重复创建容器 | _ensure_container中检查 |
| 容器异常退出 | 低 | execute失败 | 捕获异常并重建 |

### 6.2 缓解代码

```python
def _ensure_container(self) -> Container:
    if self._container is None:
        self._container = self._create_container()
        self._container.start()
    else:
        # 检查容器是否仍在运行
        try:
            self._container.reload()
            if self._container.status != "running":
                print(f"[DockerSandbox] Container not running, recreating...")
                self._container.remove(force=True)
                self._container = self._create_container()
                self._container.start()
        except docker.errors.NotFound:
            print(f"[DockerSandbox] Container not found, recreating...")
            self._container = self._create_container()
            self._container.start()
    return self._container
```

---

## 七、测试影响

### 7.1 现有测试

| 测试文件 | 影响 | 需要修改 |
|---------|------|---------|
| `tests/test_v0_1_1.py` | 应该通过 | 否（行为兼容） |
| `tests/test_mvp.py` | 应该通过 | 否（行为兼容） |

### 7.2 新增测试

| 测试文件 | 测试内容 |
|---------|---------|
| `tests/test_container_persistence.py` | 容器复用、状态保持、显式销毁 |

---

## 八、总结

### 改动范围

| 类型 | 数量 |
|------|------|
| 修改文件 | 2 |
| 新增文件 | 1 (测试) |
| 新增函数 | 3 |
| 修改函数 | 1 |
| 新增API端点 | 1 |

### 风险等级

**低风险** - 改动集中在单一模块，对外接口保持兼容

### 实施建议

1. 先修改 `docker_sandbox.py`
2. 运行现有测试确认兼容性
3. 添加新测试
4. 最后添加DELETE端点
