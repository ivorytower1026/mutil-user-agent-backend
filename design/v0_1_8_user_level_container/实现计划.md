# 实现计划

## 改动文件

`src/docker_sandbox.py`

---

## 详细改动

### 1. 全局缓存变量 (第27行)

```python
# 改动前
_thread_backends = {}

# 改动后
_user_backends = {}
```

### 2. get_thread_backend 函数 (第30-45行)

```python
# 改动前
def get_thread_backend(thread_id: str) -> 'DockerSandboxBackend':
    """Get or create a thread backend.
    
    Workspace directory structure: workspaces/{user_id}/
    All threads of the same user share the same workspace directory.
    """
    if thread_id not in _thread_backends:
        user_id = thread_id.split('-')[0]
        
        workspace_dir = os.path.join(
            Path(settings.WORKSPACE_ROOT).expanduser().absolute(),
            user_id
        )
        os.makedirs(workspace_dir, exist_ok=True)
        _thread_backends[thread_id] = DockerSandboxBackend(thread_id, workspace_dir)
    return _thread_backends[thread_id]

# 改动后
def get_thread_backend(thread_id: str) -> 'DockerSandboxBackend':
    """Get or create a user-level backend.
    
    All threads of the same user share the same container.
    Workspace directory: workspaces/{user_id}/
    """
    user_id = thread_id.split('-')[0]
    
    if user_id not in _user_backends:
        workspace_dir = os.path.join(
            Path(settings.WORKSPACE_ROOT).expanduser().absolute(),
            user_id
        )
        os.makedirs(workspace_dir, exist_ok=True)
        _user_backends[user_id] = DockerSandboxBackend(user_id, workspace_dir)
    
    return _user_backends[user_id]
```

### 3. destroy_thread_backend 函数 (第48-61行)

```python
# 改动前
def destroy_thread_backend(thread_id: str) -> bool:
    """Destroy a thread backend and its container.
    
    Args:
        thread_id: The thread ID to destroy
        
    Returns:
        True if destroyed, False if not found
    """
    if thread_id in _thread_backends:
        _thread_backends[thread_id].destroy()
        del _thread_backends[thread_id]
        return True
    return False

# 改动后
def destroy_user_backend(user_id: str) -> bool:
    """Destroy a user's backend and its container.
    
    Args:
        user_id: The user ID to destroy
        
    Returns:
        True if destroyed, False if not found
    """
    if user_id in _user_backends:
        _user_backends[user_id].destroy()
        del _user_backends[user_id]
        return True
    return False


def destroy_thread_backend(thread_id: str) -> bool:
    """Destroy a thread's container (compatibility wrapper).
    
    Args:
        thread_id: The thread ID (will extract user_id)
        
    Returns:
        True if destroyed, False if not found
    """
    user_id = thread_id.split('-')[0]
    return destroy_user_backend(user_id)
```

### 4. DockerSandboxBackend 类 (第64-76行)

```python
# 改动前
class DockerSandboxBackend(BaseSandbox):
    """Docker-based sandbox backend with persistent container."""
    
    def __init__(self, thread_id: str, workspace_dir: str):
        self.thread_id = thread_id
        self.workspace_dir = workspace_dir
        self.image = settings.DOCKER_IMAGE
        self.client = docker.from_env()
        self._container: docker.models.containers.Container | None = None

    @property
    def id(self) -> str:
        return self.thread_id

# 改动后
class DockerSandboxBackend(BaseSandbox):
    """Docker-based sandbox backend with user-level container sharing."""
    
    def __init__(self, user_id: str, workspace_dir: str):
        self.user_id = user_id
        self.workspace_dir = workspace_dir
        self.image = settings.DOCKER_IMAGE
        self.client = docker.from_env()
        self._container: docker.models.containers.Container | None = None

    @property
    def id(self) -> str:
        return self.user_id
```

### 5. 日志输出更新 (第91, 160行)

```python
# 改动前
print(f"[DockerSandbox] Created container for thread {self.thread_id}")
print(f"[DockerSandbox] Destroyed container for thread {self.thread_id}")

# 改动后
print(f"[DockerSandbox] Created container for user {self.user_id}")
print(f"[DockerSandbox] Destroyed container for user {self.user_id}")
```

---

## 完整改动后的代码

```python
_user_backends = {}


def get_thread_backend(thread_id: str) -> 'DockerSandboxBackend':
    """Get or create a user-level backend.
    
    All threads of the same user share the same container.
    Workspace directory: workspaces/{user_id}/
    """
    user_id = thread_id.split('-')[0]
    
    if user_id not in _user_backends:
        workspace_dir = os.path.join(
            Path(settings.WORKSPACE_ROOT).expanduser().absolute(),
            user_id
        )
        os.makedirs(workspace_dir, exist_ok=True)
        _user_backends[user_id] = DockerSandboxBackend(user_id, workspace_dir)
    
    return _user_backends[user_id]


def destroy_user_backend(user_id: str) -> bool:
    """Destroy a user's backend and its container."""
    if user_id in _user_backends:
        _user_backends[user_id].destroy()
        del _user_backends[user_id]
        return True
    return False


def destroy_thread_backend(thread_id: str) -> bool:
    """Destroy a thread's container (compatibility wrapper)."""
    user_id = thread_id.split('-')[0]
    return destroy_user_backend(user_id)


class DockerSandboxBackend(BaseSandbox):
    """Docker-based sandbox backend with user-level container sharing."""
    
    def __init__(self, user_id: str, workspace_dir: str):
        self.user_id = user_id
        self.workspace_dir = workspace_dir
        self.image = settings.DOCKER_IMAGE
        self.client = docker.from_env()
        self._container: docker.models.containers.Container | None = None

    @property
    def id(self) -> str:
        return self.user_id

    def _ensure_container(self) -> docker.models.containers.Container:
        if self._container is None:
            self._container = self._create_container()
            self._container.start()
            print(f"[DockerSandbox] Created container for user {self.user_id}")
        else:
            try:
                self._container.reload()
                if self._container.status != "running":
                    print(f"[DockerSandbox] Container not running, recreating...")
                    self._container.remove(force=True)
                    self._container = self._create_container()
                    self._container.start()
            except docker.errors.NotFound:
                print(f"[DockerSandbox] Container not found, recreating...")
                self._container = self._create_container()
                self._container.start()
        return self._container
    
    # ... 其他方法不变 ...

    def destroy(self) -> None:
        if self._container is not None:
            try:
                self._container.remove(force=True)
                print(f"[DockerSandbox] Destroyed container for user {self.user_id}")
            except docker.errors.APIError as e:
                print(f"[DockerSandbox] Warning: Failed to destroy container: {e}")
            finally:
                self._container = None
```

---

## 影响分析

| 调用位置 | 是否需要修改 | 说明 |
|----------|--------------|------|
| `agent_manager.py:39-41` | ❌ 否 | 接口不变 |
| `agent_manager.py:65` | ❌ 否 | 接口不变 |
| 其他潜在调用 | ❌ 否 | `destroy_thread_backend` 保持兼容 |
