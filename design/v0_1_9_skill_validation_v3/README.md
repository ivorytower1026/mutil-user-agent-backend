# v0.1.9 Skill 验证与管理

> 版本：v0.1.9-v3
> 日期：2026-02-16
> 状态：设计完成，待实现

---

## 概述

本版本实现 Agent Skill 的上传、两层验证、审批流程，支持管理员通过 zip 包上传 Skill，后台通过**双 Agent 验证机制**在 Docker 沙箱中进行动态能力验证，结合**增量镜像管理**确保新 Skill 不会破坏已有能力。

---

## 核心特性

### 双 Agent 验证机制

| Agent 角色 | 职责 |
|-----------|------|
| **验证 Agent** | 读取 SKILL.md、生成测试任务、评估执行结果、生成验证报告 |
| **执行 Agent** | 盲测执行任务（不被告知使用哪个 skill）、汇报执行结果 |

### 两层验证流程

| 层级 | 名称 | 目的 | 内容 |
|------|------|------|------|
| **第一层** | 单独验证 | 验证 skill 本身功能 | 盲测 3 个任务 + 内网验证 + 监控采集 |
| **第二层** | 回归验证 | 确保不破坏已有 skill | 全量回归测试所有已入库 skill |

### 增量镜像管理

```
skill-runtime:v1.0 → v1.1 → v1.2 → v1.3 → ...
     ↑              ↑       ↑       ↑
   基础镜像      +skill-a +skill-b +skill-c
   
每次新 skill 入库后 commit 镜像，保留最近 5 个版本
```

### 盲测机制

- 执行 Agent **不被告知**应该使用哪个 skill
- Agent 需要自主判断并选择合适的 skill
- 检验 skill 描述是否准确、触发是否可靠

### 内网验证

- **阶段 1**：联网安装依赖（pip/npm/apt/脚本）
- **阶段 2**：断开网络，执行离线测试
- 检测是否有网络调用被阻止

---

## 文档索引

| 文档 | 说明 |
|------|------|
| [四件套分析.md](./四件套分析.md) | 现象/意图/情境/边界分析 |
| [技术方案.md](./技术方案.md) | 两层验证机制、增量镜像管理、完整流程 |
| [API设计.md](./API设计.md) | API 端点、请求/响应模型、验证报告结构 |
| [数据库设计.md](./数据库设计.md) | 表结构设计、字段说明、索引设计 |
| [测试用例.md](./测试用例.md) | 集成测试用例、验收清单 |
| [迭代开发计划.md](./迭代开发计划.md) | 7 个阶段开发计划、任务拆分、验收标准 |

---

## 流程概览

```
上传 ZIP → 格式验证 → 第一层验证 → 第二层验证 → 管理员审核 → 镜像锁定 → 入库
               │            │             │            │           │
               │            │             │            │           └─ commit 新镜像版本
               │            │             │            └─ 查看报告，决定批准/拒绝
               │            │             └─ 全量回归测试
               │            └─ 盲测 + 内网 + 监控
               └─ SKILL.md/frontmatter
```

**完整流程**：

1. **上传**：管理员上传 Skill ZIP 包
2. **格式验证**：检查 SKILL.md 和 frontmatter
3. **第一层验证**：单独验证（盲测 + 内网 + 监控）
4. **第二层验证**：回归验证（全量测试已有 skill）
5. **管理员审核**：查看完整验证报告，决定是否入库
6. **镜像锁定**：批准后 commit 容器为新镜像版本
7. **入库**：更新状态为 approved，skill 对 Agent 可用

---

## 文件结构

```
src/
├── skill_manager.py           # Skill CRUD + 状态流转
├── skill_validator.py         # 格式验证（frontmatter/目录结构）
├── skill_agent_validator.py   # 双 Agent 两层验证（核心）
├── skill_metrics.py           # 执行监控采集
├── skill_image_manager.py     # 增量镜像管理
└── database.py                # 新增 Skill 表

api/
└── admin.py                   # 管理员 API 路由

tests/
└── test_skills_api.py         # 集成测试
```

---

## 配置项

```env
# Skill 验证配置
SKILL_VALIDATION_THRESHOLD=70         # 评分警告阈值（0-100）
SKILL_VALIDATION_TASKS=3              # 每层测试任务数量
SKILL_RUNTIME_IMAGE_PREFIX=skill-runtime  # 生产镜像前缀
SKILL_IMAGE_VERSIONS_TO_KEEP=5        # 保留历史镜像版本数
```

---

## 预计工作量

| 阶段 | 内容 | 预计时间 |
|------|------|----------|
| Phase 1 | 数据库模型 + 迁移 | 0.5天 |
| Phase 2 | 格式验证器 | 0.5天 |
| Phase 3 | 第一层验证（单独验证） | 1天 |
| Phase 4 | 第二层验证（回归验证） | 1天 |
| Phase 5 | 增量镜像管理 | 0.5天 |
| Phase 6 | Skill 管理器 + Admin API | 0.5天 |
| Phase 7 | 集成测试 | 0.5天 |

**总计：约 4.5 天**

---

## 关键设计决策

| 决策项 | 选择 | 原因 |
|--------|------|------|
| 验证层数 | 2 层 | 单独验证 + 回归验证，确保新 skill 不破坏已有能力 |
| 协同验证 | 不做 | 回归验证已覆盖依赖冲突问题 |
| 内网验证 | 分阶段 | 先联网安装依赖，再断网测试 |
| 依赖安装 | Agent 智能分析 | 支持多种依赖类型（pip/npm/apt/脚本） |
| 镜像管理 | 增量镜像 | 每次入库 commit，保留最近 5 个版本 |
| 盲测机制 | 需要 | 检验 skill 触发准确性 |
| 验证失败 | 保留报告 | 供管理员查看失败原因 |
| **最终审批** | **人工审核** | **验证完成后需管理员查看报告并决定是否入库** |
