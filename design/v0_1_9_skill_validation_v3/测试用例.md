# 测试用例

> v0.1.9 Skill 验证与管理

---

## 一、测试环境

### 1.1 前置条件

- 服务器运行在 `http://localhost:{PORT}`
- 数据库已创建 `skills` 和 `image_versions` 表
- 存在管理员账户 `admin` / 普通账户 `user`
- Docker 服务正常运行

### 1.2 测试数据

**有效 Skill zip 结构**:
```
csv-analyzer/
├── SKILL.md
└── helper.py
```

**SKILL.md 内容**:
```markdown
---
name: csv-analyzer
description: CSV 数据分析工具
---

# CSV Analyzer

## 功能
分析 CSV 文件并生成统计报告。

## 使用方法
1. 读取 CSV 文件
2. 生成统计摘要
3. 输出分析结果
```

---

## 二、测试用例列表

### 2.1 上传测试

| 用例 ID | 用例名称 | 说明 | 预期结果 |
|---------|----------|------|----------|
| U-001 | test_upload_valid_skill | 上传有效 Skill | 200, status=pending |
| U-002 | test_upload_missing_skill_md | 缺少 SKILL.md | 400, INVALID_SKILL_FORMAT |
| U-003 | test_upload_invalid_frontmatter | frontmatter 格式错误 | 400, INVALID_SKILL_FORMAT |
| U-004 | test_upload_duplicate_name | 重名上传 | 409, SKILL_ALREADY_EXISTS |
| U-005 | test_upload_invalid_zip | 无效 zip 文件 | 400, INVALID_ZIP |
| U-006 | test_upload_file_too_large | 超过 50MB | 413, FILE_TOO_LARGE |
| U-007 | test_upload_non_admin | 非管理员上传 | 403, FORBIDDEN |

### 2.2 第一层验证测试

| 用例 ID | 用例名称 | 说明 | 预期结果 |
|---------|----------|------|----------|
| L1-001 | test_layer1_validation_completes | 第一层验证完成 | layer1_passed=true |
| L1-002 | test_layer1_score_range | 评分范围 | score 在 0-100 之间 |
| L1-003 | test_blind_test_skill_triggered | 盲测：Agent 自主选择 skill | skill_triggered=True |
| L1-004 | test_blind_test_all_correct | 盲测：全部正确选择 | blind_test_passed=True |
| L1-005 | test_network_blocked_detection | 内网验证：检测网络调用 | blocked_network_calls > 0 |
| L1-006 | test_offline_capable | 内网验证：离线可用 | offline_capable=True |
| L1-007 | test_metrics_collection | 监控采集 | 返回完整指标 |
| L1-008 | test_low_score_warning | 评分低于70分 | 返回 warning 字段 |
| L1-009 | test_layer1_failure_reject | 第一层验证失败 | status=rejected |
| L1-010 | test_dependency_installation | 依赖安装 | pip/npm 包正确安装 |

### 2.3 第二层验证测试（回归）

| 用例 ID | 用例名称 | 说明 | 预期结果 |
|---------|----------|------|----------|
| L2-001 | test_layer2_validation_completes | 第二层验证完成 | layer2_passed=true |
| L2-002 | test_regression_all_pass | 回归：全部通过 | 所有 skill passed=true |
| L2-003 | test_regression_failure | 回归：有失败 | layer2_passed=false |
| L2-004 | test_regression_report | 回归报告 | 包含每个 skill 的结果 |
| L2-005 | test_no_approved_skills | 无已入库 skill 时 | 跳过第二层，直接通过 |

### 2.4 镜像版本管理测试

| 用例 ID | 用例名称 | 说明 | 预期结果 |
|---------|----------|------|----------|
| I-001 | test_image_version_increment | 镜像版本递增 | v1.2 → v1.3 |
| I-002 | test_image_version_list | 镜像版本列表 | 返回所有版本 |
| I-003 | test_image_rollback | 镜像回滚 | 回滚成功，skill 标记为 rollback_pending |
| I-004 | test_image_cleanup | 清理旧版本 | 保留最近 5 个版本 |
| I-005 | test_skill_image_version_record | skill 记录镜像版本 | runtime_image_version 正确 |

### 2.5 审批测试

| 用例 ID | 用例名称 | 说明 | 预期结果 |
|---------|----------|------|----------|
| A-001 | test_approve_pending_skill | 批准 pending | status=approved, 文件移动 |
| A-002 | test_approve_validating_skill | 批准 validating | 400, INVALID_STATUS_TRANSITION |
| A-003 | test_approve_without_validation | 未验证完成批准 | 400, VALIDATION_NOT_COMPLETED |
| A-004 | test_reject_pending_skill | 拒绝 pending | status=rejected |
| A-005 | test_approve_non_admin | 非管理员批准 | 403, FORBIDDEN |

### 2.6 查询测试

| 用例 ID | 用例名称 | 说明 | 预期结果 |
|---------|----------|------|----------|
| Q-001 | test_list_all_skills | 列出所有 | 返回分页列表 |
| Q-002 | test_list_filter_by_status | 按状态过滤 | 只返回对应状态 |
| Q-003 | test_list_filter_by_stage | 按验证阶段过滤 | 只返回对应阶段 |
| Q-004 | test_get_skill_detail | 获取详情 | 返回完整信息 |
| Q-005 | test_get_nonexistent_skill | 获取不存在 | 404, SKILL_NOT_FOUND |
| Q-006 | test_get_validation_report | 获取报告 | 返回结构化报告 |
| Q-007 | test_get_report_layer1_only | 仅第一层完成 | 报告只含 layer1_result |

### 2.7 删除测试

| 用例 ID | 用例名称 | 说明 | 预期结果 |
|---------|----------|------|----------|
| D-001 | test_delete_rejected_skill | 删除 rejected | 200, 文件删除 |
| D-002 | test_delete_approved_skill | 删除 approved | 200, 文件删除 |
| D-003 | test_delete_pending_skill | 删除 pending | 400, INVALID_STATUS_TRANSITION |
| D-004 | test_delete_validating_skill | 删除 validating | 400, INVALID_STATUS_TRANSITION |

### 2.8 并发与异常测试

| 用例 ID | 用例名称 | 说明 | 预期结果 |
|---------|----------|------|----------|
| C-001 | test_concurrent_validation_blocked | 并发验证阻止 | 第二个返回 409 |
| C-002 | test_validation_timeout | 验证超时 | 返回超时错误 |
| C-003 | test_dependency_install_failed | 依赖安装失败 | 返回错误报告 |
| C-004 | test_container_crash_recovery | 容器崩溃恢复 | 自动清理并返回错误 |

---

## 三、测试代码

### 3.1 辅助函数

```python
# tests/test_skills_api.py

import os
import time
import zipfile
import requests
from pathlib import Path

BASE_URL = os.environ.get("BASE_URL", "http://localhost:8002")
ADMIN_TOKEN = None
USER_TOKEN = None


def create_skill_zip(name: str, skill_md_content: str, include_skill_md: bool = True) -> str:
    """创建测试用 Skill zip"""
    zip_path = f"/tmp/{name}.zip"
    with zipfile.ZipFile(zip_path, 'w') as zf:
        if include_skill_md:
            zf.writestr(f"{name}/SKILL.md", skill_md_content)
    return zip_path


def wait_for_validation(skill_id: str, timeout: int = 600) -> dict:
    """等待验证完成（两层）"""
    start = time.time()
    while time.time() - start < timeout:
        resp = requests.get(
            f"{BASE_URL}/api/admin/skills/{skill_id}",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
        )
        data = resp.json()
        if data["status"] != "validating":
            return data
        time.sleep(2)
    raise TimeoutError("Validation timeout")


def wait_for_layer1(skill_id: str, timeout: int = 300) -> dict:
    """等待第一层验证完成"""
    start = time.time()
    while time.time() - start < timeout:
        resp = requests.get(
            f"{BASE_URL}/api/admin/skills/{skill_id}",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
        )
        data = resp.json()
        if data.get("layer1_passed") is not None or data["status"] == "rejected":
            return data
        time.sleep(2)
    raise TimeoutError("Layer1 validation timeout")
```

### 3.2 上传测试

```python
def test_upload_valid_skill():
    """[U-001] 上传有效 Skill"""
    zip_path = create_skill_zip(
        "csv-analyzer",
        """---
name: csv-analyzer
description: CSV 数据分析工具
---

# CSV Analyzer
分析 CSV 文件并生成统计报告。
"""
    )
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
            files={"file": ("csv-analyzer.zip", f)}
        )
    
    assert resp.status_code == 200, f"Expected 200, got {resp.status_code}: {resp.text}"
    data = resp.json()
    assert data["status"] == "pending"
    assert data["format_valid"] == True
    
    print("[PASS] U-001: test_upload_valid_skill")
    return data["skill_id"]


def test_upload_missing_skill_md():
    """[U-002] 上传缺少 SKILL.md 的 Skill"""
    zip_path = create_skill_zip("no-skill-md", "", include_skill_md=False)
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
            files={"file": ("no-skill-md.zip", f)}
        )
    
    assert resp.status_code == 400
    data = resp.json()
    assert data["code"] == "INVALID_SKILL_FORMAT"
    assert "SKILL.md" in data["message"]
    
    print("[PASS] U-002: test_upload_missing_skill_md")


def test_upload_duplicate_name():
    """[U-004] 上传重名 Skill"""
    skill_id = test_upload_valid_skill()
    
    zip_path = create_skill_zip(
        "csv-analyzer",
        """---
name: csv-analyzer
description: 另一个
---
# Test
"""
    )
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
            files={"file": ("csv-analyzer.zip", f)}
        )
    
    assert resp.status_code == 409
    assert resp.json()["code"] == "SKILL_ALREADY_EXISTS"
    
    print("[PASS] U-004: test_upload_duplicate_name")


def test_upload_non_admin():
    """[U-007] 非管理员上传"""
    zip_path = create_skill_zip(
        "user-skill",
        """---
name: user-skill
description: Test
---
# Test
"""
    )
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {USER_TOKEN}"},
            files={"file": ("user-skill.zip", f)}
        )
    
    assert resp.status_code == 403
    
    print("[PASS] U-007: test_upload_non_admin")
```

### 3.3 第一层验证测试

```python
def test_layer1_validation_completes():
    """[L1-001] 第一层验证完成"""
    zip_path = create_skill_zip(
        "layer1-test",
        """---
name: layer1-test
description: 第一层验证测试
---

# Layer1 Test
这是一个验证测试 Skill。

## 使用方法
1. 步骤一
2. 步骤二
"""
    )
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
            files={"file": ("layer1-test.zip", f)}
        )
    
    skill_id = resp.json()["skill_id"]
    skill = wait_for_layer1(skill_id)
    
    assert skill["layer1_passed"] == True
    assert skill["validation_score"] is not None
    assert 0 <= skill["validation_score"] <= 100
    
    print(f"[PASS] L1-001: test_layer1_validation_completes (score: {skill['validation_score']})")
    return skill_id


def test_blind_test_skill_triggered():
    """[L1-003] 盲测：Agent 是否自主选择 skill"""
    skill_id = test_layer1_validation_completes()
    
    resp = requests.get(
        f"{BASE_URL}/api/admin/skills/{skill_id}/report",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    report = resp.json()
    assert report["layer1_result"]["blind_test"]["skill_triggered"] == True
    
    print("[PASS] L1-003: test_blind_test_skill_triggered")


def test_network_blocked_detection():
    """[L1-005] 内网验证：检测网络调用"""
    zip_path = create_skill_zip(
        "web-fetcher",
        """---
name: web-fetcher
description: 网页获取工具
---

# Web Fetcher
从指定 URL 获取网页内容。
"""
    )
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
            files={"file": ("web-fetcher.zip", f)}
        )
    
    skill_id = resp.json()["skill_id"]
    skill = wait_for_layer1(skill_id)
    
    # 获取报告
    resp = requests.get(
        f"{BASE_URL}/api/admin/skills/{skill_id}/report",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    report = resp.json()
    network_test = report["layer1_result"]["network_test"]
    
    assert network_test["blocked_network_calls"] > 0
    assert network_test["offline_capable"] == False
    
    print(f"[PASS] L1-005: test_network_blocked_detection (blocked: {network_test['blocked_network_calls']})")


def test_metrics_collection():
    """[L1-007] 监控采集"""
    skill_id = test_layer1_validation_completes()
    
    resp = requests.get(
        f"{BASE_URL}/api/admin/skills/{skill_id}/report",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    report = resp.json()
    metrics = report["layer1_result"]["execution_metrics"]
    
    assert "cpu_percent" in metrics
    assert "memory_mb" in metrics
    assert "disk_read_mb" in metrics
    assert "disk_write_mb" in metrics
    assert "execution_time_sec" in metrics
    
    assert metrics["cpu_percent"] >= 0
    assert metrics["memory_mb"] > 0
    assert metrics["execution_time_sec"] > 0
    
    print(f"[PASS] L1-007: test_metrics_collection")


def test_low_score_warning():
    """[L1-008] 评分低于70分"""
    zip_path = create_skill_zip(
        "poor-skill",
        """---
name: poor-skill
description: 测试用低分 skill
---

# Poor Skill
这个 skill 设计有问题。
"""
    )
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
            files={"file": ("poor-skill.zip", f)}
        )
    
    skill_id = resp.json()["skill_id"]
    skill = wait_for_layer1(skill_id)
    
    if skill["validation_score"] < 70:
        resp = requests.get(
            f"{BASE_URL}/api/admin/skills/{skill_id}/report",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
        )
        
        report = resp.json()
        assert report["warning"] is not None
        assert "低于阈值" in report["warning"]
        
        print(f"[PASS] L1-008: test_low_score_warning (score: {skill['validation_score']})")
    else:
        print("[SKIP] L1-008: test_low_score_warning (skill score >= 70)")
```

### 3.4 第二层验证测试

```python
def test_layer2_validation_completes():
    """[L2-001] 第二层验证完成"""
    zip_path = create_skill_zip(
        "layer2-test",
        """---
name: layer2-test
description: 第二层验证测试
---

# Layer2 Test
"""
    )
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
            files={"file": ("layer2-test.zip", f)}
        )
    
    skill_id = resp.json()["skill_id"]
    skill = wait_for_validation(skill_id)
    
    assert skill["layer1_passed"] == True
    assert skill["layer2_passed"] == True
    assert skill["validation_stage"] == "completed"
    
    print("[PASS] L2-001: test_layer2_validation_completes")
    return skill_id


def test_regression_report():
    """[L2-004] 回归报告"""
    skill_id = test_layer2_validation_completes()
    
    resp = requests.get(
        f"{BASE_URL}/api/admin/skills/{skill_id}/report",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    report = resp.json()
    assert report["layer2_result"] is not None
    
    layer2 = report["layer2_result"]
    assert "regression_results" in layer2
    assert "total_skills_tested" in layer2
    assert "failed_skills" in layer2
    
    print(f"[PASS] L2-004: test_regression_report (tested: {layer2['total_skills_tested']})")


def test_no_approved_skills():
    """[L2-005] 无已入库 skill 时"""
    # 需要在一个干净的环境中测试
    # 或者先删除所有 approved skill
    
    resp = requests.get(
        f"{BASE_URL}/api/admin/skills?status=approved",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    if resp.json()["total"] == 0:
        skill_id = test_layer2_validation_completes()
        
        resp = requests.get(
            f"{BASE_URL}/api/admin/skills/{skill_id}/report",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
        )
        
        report = resp.json()
        # 第二层应该直接通过
        assert report["layer2_result"]["passed"] == True
        assert report["layer2_result"]["total_skills_tested"] == 0
        
        print("[PASS] L2-005: test_no_approved_skills")
    else:
        print("[SKIP] L2-005: test_no_approved_skills (approved skills exist)")
```

### 3.5 镜像版本管理测试

```python
def test_image_version_increment():
    """[I-001] 镜像版本递增"""
    # 获取当前版本
    resp = requests.get(
        f"{BASE_URL}/api/admin/images",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    current_version = resp.json()["current_version"]
    
    # 上传并批准一个新 skill
    skill_id = test_layer2_validation_completes()
    
    resp = requests.post(
        f"{BASE_URL}/api/admin/skills/{skill_id}/approve",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    # 检查版本递增
    resp = requests.get(
        f"{BASE_URL}/api/admin/images",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    new_version = resp.json()["current_version"]
    
    assert new_version > current_version
    
    print(f"[PASS] I-001: test_image_version_increment ({current_version} -> {new_version})")


def test_image_rollback():
    """[I-003] 镜像回滚"""
    # 获取版本列表
    resp = requests.get(
        f"{BASE_URL}/api/admin/images",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    versions = resp.json()["versions"]
    
    if len(versions) < 2:
        print("[SKIP] I-003: test_image_rollback (need at least 2 versions)")
        return
    
    # 回滚到上一个版本
    target_version = versions[1]["version"]
    
    resp = requests.post(
        f"{BASE_URL}/api/admin/images/rollback",
        headers={
            "Authorization": f"Bearer {ADMIN_TOKEN}",
            "Content-Type": "application/json"
        },
        json={"target_version": target_version}
    )
    
    assert resp.status_code == 200
    data = resp.json()
    assert data["target_version"] == target_version
    assert len(data["affected_skills"]) > 0
    
    # 检查受影响的 skill 状态
    resp = requests.get(
        f"{BASE_URL}/api/admin/skills?status=rollback_pending",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    assert resp.json()["total"] > 0
    
    print(f"[PASS] I-003: test_image_rollback (affected: {len(data['affected_skills'])})")
```

### 3.6 审批测试

```python
def test_approve_pending_skill():
    """[A-001] 批准 pending Skill"""
    skill_id = test_layer2_validation_completes()
    
    resp = requests.post(
        f"{BASE_URL}/api/admin/skills/{skill_id}/approve",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    assert resp.status_code == 200
    data = resp.json()
    assert data["status"] == "approved"
    assert data["runtime_image_version"] is not None
    assert data["approved_at"] is not None
    
    # 验证文件移动
    detail = requests.get(
        f"{BASE_URL}/api/admin/skills/{skill_id}",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    ).json()
    assert detail["skill_path"].startswith("skills/")
    
    print("[PASS] A-001: test_approve_pending_skill")


def test_approve_without_validation():
    """[A-003] 未验证完成批准"""
    zip_path = create_skill_zip(
        "not-validated",
        """---
name: not-validated
description: Test
---
# Test
"""
    )
    
    with open(zip_path, 'rb') as f:
        resp = requests.post(
            f"{BASE_URL}/api/admin/skills/upload",
            headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
            files={"file": ("not-validated.zip", f)}
        )
    
    skill_id = resp.json()["skill_id"]
    
    # 立即尝试批准（验证未完成）
    resp = requests.post(
        f"{BASE_URL}/api/admin/skills/{skill_id}/approve",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    # 应该返回错误
    assert resp.status_code == 400
    assert resp.json()["code"] in ["VALIDATION_NOT_COMPLETED", "INVALID_STATUS_TRANSITION"]
    
    print("[PASS] A-003: test_approve_without_validation")


def test_reject_pending_skill():
    """[A-004] 拒绝 pending Skill"""
    skill_id = test_layer2_validation_completes()
    
    resp = requests.post(
        f"{BASE_URL}/api/admin/skills/{skill_id}/reject",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
        json={"reason": "Score too low"}
    )
    
    assert resp.status_code == 200
    data = resp.json()
    assert data["status"] == "rejected"
    assert data["reject_reason"] == "Score too low"
    
    print("[PASS] A-004: test_reject_pending_skill")
```

### 3.7 并发测试

```python
def test_concurrent_validation_blocked():
    """[C-001] 并发验证被阻止"""
    # 上传两个 Skill
    ids = []
    for i in range(2):
        zip_path = create_skill_zip(
            f"concurrent-{i}",
            f"""---
name: concurrent-{i}
description: 并发测试 {i}
---
# Test {i}
"""
        )
        
        with open(zip_path, 'rb') as f:
            resp = requests.post(
                f"{BASE_URL}/api/admin/skills/upload",
                headers={"Authorization": f"Bearer {ADMIN_TOKEN}"},
                files={"file": (f"concurrent-{i}.zip", f)}
            )
        ids.append(resp.json()["skill_id"])
    
    # 立即请求重新验证两个
    resp1 = requests.post(
        f"{BASE_URL}/api/admin/skills/{ids[0]}/revalidate",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    time.sleep(1)
    
    resp2 = requests.post(
        f"{BASE_URL}/api/admin/skills/{ids[1]}/revalidate",
        headers={"Authorization": f"Bearer {ADMIN_TOKEN}"}
    )
    
    # 其中一个应该被阻止
    statuses = [resp1.status_code, resp2.status_code]
    assert 409 in statuses, f"Expected one 409, got {statuses}"
    
    print("[PASS] C-001: test_concurrent_validation_blocked")
```

---

## 四、验收清单

### 4.1 功能验收

**上传功能**
- [ ] 管理员可上传 Skill zip
- [ ] 格式错误返回明确错误信息
- [ ] 重名上传被拒绝
- [ ] 非管理员无权操作

**第一层验证**
- [ ] 自动触发第一层验证
- [ ] 盲测机制验证 Agent 自主选择 skill
- [ ] 内网验证正常工作
- [ ] 执行监控指标正确采集
- [ ] 验证报告包含评分和建议

**第二层验证**
- [ ] 第一层通过后自动触发第二层
- [ ] 全量回归所有已入库 skill
- [ ] 记录每个 skill 的回归结果

**镜像管理**
- [ ] 批准后自动 commit 新镜像
- [ ] 镜像版本正确递增
- [ ] 旧版本自动清理（保留 5 个）
- [ ] 回滚功能正常

**审批流程**
- [ ] 可批准 Skill 入库
- [ ] 可拒绝 Skill
- [ ] approved 的 Skill 在 /skills/ 可见
- [ ] skill 记录正确的镜像版本

### 4.2 回归验收

- [ ] 现有 API 不受影响
- [ ] Agent 对话功能正常
- [ ] 用户认证正常
- [ ] Docker 服务正常

### 4.3 性能验收

| 指标 | 预期值 |
|------|--------|
| 第一层验证时间 | < 5 分钟 |
| 第二层验证时间 | < N 分钟（N = 已入库 skill 数量 × 1分钟） |
| 并发验证 | 同时只允许 1 个 |
| 镜像 commit 时间 | < 30 秒 |

---

## 五、测试运行

### 5.1 运行所有测试

```python
def run_all_tests():
    """运行所有测试"""
    global ADMIN_TOKEN, USER_TOKEN
    
    print("=" * 60)
    print("Running Skills API Tests (v3)")
    print("=" * 60)
    
    ADMIN_TOKEN = get_admin_token()
    USER_TOKEN = get_user_token()
    
    tests = [
        # 上传测试
        ("U-001", "上传有效 Skill", test_upload_valid_skill),
        ("U-002", "上传缺少 SKILL.md", test_upload_missing_skill_md),
        ("U-004", "上传重名 Skill", test_upload_duplicate_name),
        ("U-007", "非管理员上传", test_upload_non_admin),
        
        # 第一层验证测试
        ("L1-001", "第一层验证完成", test_layer1_validation_completes),
        ("L1-003", "盲测：Agent 自主选择", test_blind_test_skill_triggered),
        ("L1-005", "内网验证：检测网络调用", test_network_blocked_detection),
        ("L1-007", "监控采集", test_metrics_collection),
        ("L1-008", "低分警告", test_low_score_warning),
        
        # 第二层验证测试
        ("L2-001", "第二层验证完成", test_layer2_validation_completes),
        ("L2-004", "回归报告", test_regression_report),
        
        # 镜像管理测试
        ("I-001", "镜像版本递增", test_image_version_increment),
        ("I-003", "镜像回滚", test_image_rollback),
        
        # 审批测试
        ("A-001", "批准 Skill", test_approve_pending_skill),
        ("A-003", "未验证完成批准", test_approve_without_validation),
        ("A-004", "拒绝 Skill", test_reject_pending_skill),
        
        # 并发测试
        ("C-001", "并发验证阻止", test_concurrent_validation_blocked),
    ]
    
    passed = 0
    failed = 0
    skipped = 0
    
    for test_id, name, test_fn in tests:
        print(f"\n[{test_id}] {name}...")
        try:
            test_fn()
            passed += 1
        except AssertionError as e:
            print(f"[FAIL] {e}")
            failed += 1
        except Exception as e:
            print(f"[ERROR] {type(e).__name__}: {e}")
            failed += 1
    
    print("\n" + "=" * 60)
    print(f"Results: {passed} passed, {failed} failed, {skipped} skipped")
    print("=" * 60)
    
    return failed == 0


if __name__ == "__main__":
    import sys
    success = run_all_tests()
    sys.exit(0 if success else 1)
```

### 5.2 单独运行某个测试

```bash
# 修改 test_skills_api.py，只保留要运行的测试函数
# 然后运行
uv run python tests/test_skills_api.py
```
