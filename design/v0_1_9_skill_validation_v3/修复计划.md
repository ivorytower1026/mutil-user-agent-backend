# å‰åç«¯ä¿®å¤è®¡åˆ’ v2

> åŸºäºè®¾è®¡æ–‡æ¡£ä¸ç°æœ‰ä»£ç çš„å…¨é¢å·®å¼‚åˆ†æ
> æ—¥æœŸï¼š2026-02-19
> ç‰ˆæœ¬ï¼šv2ï¼ˆå®Œæ•´ç‰ˆï¼‰

---

## ä¸€ã€é—®é¢˜æ€»è§ˆ

| ä¼˜å…ˆçº§ | é—®é¢˜åˆ†ç±» | é—®é¢˜æè¿° | è´£ä»»æ–¹ | æ–‡ä»¶ | çŠ¶æ€ |
|--------|----------|----------|--------|------|------|
| **P0** | éªŒè¯æµç¨‹ | **ç¬¬äºŒå±‚éªŒè¯ï¼ˆLayer2ï¼‰æœªå®ç°** | åç«¯ | `skill_validator.py` | å¾…ä¿®å¤ |
| **P0** | éªŒè¯æµç¨‹ | **ç¦»çº¿æµ‹è¯•æœªå®ç°**ï¼ˆåªæ‰§è¡Œäº† echoï¼‰ | åç«¯ | `skill_validator.py` | å¾…ä¿®å¤ |
| **P0** | éªŒè¯æµç¨‹ | **ç½‘ç»œæ–­å¼€æœªå®ç°** | åç«¯ | `skill_validator.py` | å¾…ä¿®å¤ |
| **P0** | éªŒè¯æµç¨‹ | **MetricsCollector æœªå¯åŠ¨** | åç«¯ | `skill_validator.py` | å¾…ä¿®å¤ |
| P0 | APIç«¯ç‚¹ | ç¼ºå°‘ `revalidate` ç«¯ç‚¹ | åç«¯ | `api/admin.py` | å¾…ä¿®å¤ |
| P0 | APIç«¯ç‚¹ | `approve` è¿”å›å­—æ®µä¸å®Œæ•´ | åç«¯ | `api/admin.py` | å¾…ä¿®å¤ |
| P0 | APIç«¯ç‚¹ | `reject` è¿”å›å­—æ®µä¸å®Œæ•´ | åç«¯ | `api/admin.py` | å¾…ä¿®å¤ |
| P1 | æ•°æ®åº“ | ç¼ºå°‘ 8 ä¸ªç‹¬ç«‹éªŒè¯å­—æ®µ | åç«¯ | `database.py` | å¾…ä¿®å¤ |
| P1 | APIç«¯ç‚¹ | ç¼ºå°‘é•œåƒç‰ˆæœ¬ç®¡ç†ç«¯ç‚¹ | åç«¯ | `api/admin.py` | å¾…ä¿®å¤ |
| P1 | APIç«¯ç‚¹ | åˆ†é¡µå‚æ•°æœªå®ç° | åç«¯ | `api/admin.py` | å¾…ä¿®å¤ |
| P1 | APIç«¯ç‚¹ | SkillResponse å­—æ®µç¼ºå¤± | åç«¯ | `api/admin.py` | å¾…ä¿®å¤ |
| P1 | æŠ¥å‘Šç”Ÿæˆ | æŠ¥å‘Šå†…å®¹ä¸å®Œæ•´ | åç«¯ | `api/admin.py` | å¾…ä¿®å¤ |
| P2 | å‰ç«¯é€‚é… | æŠ¥å‘Šè¿”å›æ ¼å¼é€‚é… | å‰ç«¯ | `stores/adminSkill.ts` | å¾…ä¿®å¤ |

---

## äºŒã€åç«¯ä¿®å¤è¯¦æƒ…

### 2.1 æ•°æ®åº“æ¨¡å‹è¡¥å…¨ (P1)

**è®¾è®¡è¦æ±‚**ï¼šæ•°æ®åº“è®¾è®¡.md line 63-82

**ç¼ºå¤±å­—æ®µ**ï¼ˆ8ä¸ªï¼‰ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `blind_test_passed` | Boolean | ç›²æµ‹æ˜¯å¦é€šè¿‡ |
| `skill_triggered` | Boolean | Agent æ˜¯å¦ä½¿ç”¨äº†è¯¥ skill |
| `trigger_accuracy` | Float | è§¦å‘å‡†ç¡®ç‡ï¼ˆ0.0-1.0ï¼‰ |
| `network_test_passed` | Boolean | ç½‘ç»œæµ‹è¯•æ˜¯å¦é€šè¿‡ |
| `offline_capable` | Boolean | æ˜¯å¦å¯ç¦»çº¿è¿è¡Œ |
| `blocked_network_calls` | Integer | è¢«é˜»æ­¢çš„ç½‘ç»œè°ƒç”¨æ¬¡æ•° |
| `execution_metrics` | JSON | æ‰§è¡Œç›‘æ§æŒ‡æ ‡ |
| `task_results` | JSON | ä»»åŠ¡ç»“æœåˆ—è¡¨ |

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `src/database.py` Skill ç±»ä¸­æ·»åŠ å­—æ®µ

---

### 2.2 å®ç°ç¬¬äºŒå±‚éªŒè¯ï¼ˆLayer2 - å¹¶è¡Œå›å½’æµ‹è¯•ï¼‰(P0) ğŸ”¥

**è®¾è®¡è¦æ±‚**ï¼šæŠ€æœ¯æ–¹æ¡ˆ.md line 388-555

**ç°æœ‰é—®é¢˜**ï¼š
- `skill_validator.py` åªæœ‰ `_validate_layer1` æ–¹æ³•
- Layer1 å®Œæˆåç›´æ¥æ ‡è®° `validation_stage=completed`ï¼Œè·³è¿‡äº† Layer2

**å…³é”®ç‚¹**ï¼š
1. **Layer2 åœ¨ Layer1 é€šè¿‡åæ‰æ‰§è¡Œ**
2. **å¹¶è¡Œå›å½’**ï¼šä½¿ç”¨ `asyncio.gather` åŒæ—¶æµ‹è¯•å¤šä¸ªå·²å…¥åº“ skill
3. **ç‹¬ç«‹å®¹å™¨**ï¼šæ¯ä¸ªå›å½’æµ‹è¯•ä½¿ç”¨ç‹¬ç«‹å®¹å™¨ï¼Œé¿å…çŠ¶æ€æ±¡æŸ“
4. **å¤±è´¥æŠ¥å‘Š**ï¼šLayer2 å¤±è´¥æ—¶ä»ä¿å­˜æŠ¥å‘Šï¼Œä¾›ç®¡ç†å‘˜æŸ¥çœ‹å“ªäº› skill å—å½±å“

**æ€§èƒ½ä¼˜åŠ¿**ï¼š
| æ–¹æ¡ˆ | 10 ä¸ªå·²å…¥åº“ skill | è¯´æ˜ |
|------|------------------|------|
| ä¸²è¡Œ | ~10 åˆ†é’Ÿ | 10 Ã— 1åˆ†é’Ÿ |
| **å¹¶è¡Œ** | **~1-2 åˆ†é’Ÿ** | asyncio.gather |

---

### 2.3 å®ç°ç¦»çº¿æµ‹è¯• (P0)

**è®¾è®¡è¦æ±‚**ï¼šæŠ€æœ¯æ–¹æ¡ˆ.md line 1084-1115

**ç°æœ‰ä»£ç **ï¼ˆline 464-476ï¼‰ï¼š
```python
async def _run_offline_test(self, backend: DockerSandboxBackend, skill) -> dict:
    """Run offline blind test."""
    result = backend.execute("echo 'Offline test completed'")  # âŒ åªæ‰§è¡Œäº† echo
    return {"passed": True, "blocked_network_calls": 0, "offline_capable": True}
```

**ä¿®å¤è¦ç‚¹**ï¼š
1. è°ƒç”¨ `backend.disconnect_network()` æ–­å¼€ç½‘ç»œ
2. æ‰§è¡ŒçœŸå®çš„ç¦»çº¿ç›²æµ‹ä»»åŠ¡
3. æ£€æµ‹æ—¥å¿—ä¸­çš„ç½‘ç»œè°ƒç”¨é”™è¯¯
4. è°ƒç”¨ `backend.reconnect_network()` æ¢å¤ç½‘ç»œ

---

### 2.4 å®ç° MetricsCollector å¯åŠ¨ (P0)

**ç°æœ‰ä»£ç **ï¼ˆline 240ï¼‰ï¼š
```python
metrics_collector.start_time = datetime.utcnow()  # âŒ åªè®¾ç½®äº†æ—¶é—´
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `asyncio.create_task()` å¯åŠ¨åå°æ”¶é›†ä»»åŠ¡

---

### 2.5 æ·»åŠ  `revalidate` ç«¯ç‚¹ (P0)

**è®¾è®¡è¦æ±‚**ï¼šAPIè®¾è®¡.md line 686-710

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `api/admin.py` æ·»åŠ  `/skills/{skill_id}/revalidate` ç«¯ç‚¹

---

### 2.6 ä¿®å¤ `approve` è¿”å›æ ¼å¼ (P0)

**è®¾è®¡è¦æ±‚**ï¼šAPIè®¾è®¡.md line 649-657

```json
{
  "skill_id": "uuid-xxx",
  "name": "csv-analyzer",
  "status": "approved",
  "runtime_image_version": "v1.3",
  "approved_at": "2026-02-16T10:30:00Z",
  "message": "Skill approved and available to agents"
}
```

---

### 2.7 ä¿®å¤ `reject` è¿”å›æ ¼å¼ (P0)

**è®¾è®¡è¦æ±‚**ï¼šAPIè®¾è®¡.md line 664-683

```json
{
  "skill_id": "uuid-xxx",
  "status": "rejected",
  "rejected_at": "2026-02-16T10:30:00Z",
  "reject_reason": "Validation score too low"
}
```

---

### 2.8 è¡¥å…¨ `SkillResponse` å­—æ®µ (P1)

**è®¾è®¡è¦æ±‚**ï¼šAPIè®¾è®¡.md line 48-83

**ç¼ºå¤±å­—æ®µ**ï¼š
- `blind_test_passed`, `skill_triggered`, `trigger_accuracy`
- `network_test_passed`, `offline_capable`, `blocked_network_calls`
- `execution_metrics`, `task_results`, `regression_results`
- `installed_dependencies`, `runtime_image_version`
- `rejected_by`, `rejected_at`, `reject_reason`

**ä¿®å¤æ–¹æ¡ˆ**ï¼šä» `layer1_report` å’Œ `layer2_report` JSON å­—æ®µä¸­æå–

---

### 2.9 å®ç°åˆ†é¡µ (P1)

**è®¾è®¡è¦æ±‚**ï¼šAPIè®¾è®¡.md line 247-254

```json
{
  "skills": [...],
  "total": 10,
  "page": 1,
  "size": 20
}
```

---

### 2.10 æ·»åŠ é•œåƒç‰ˆæœ¬ç®¡ç† API (P1)

**è®¾è®¡è¦æ±‚**ï¼šAPIè®¾è®¡.md line 733-793

**ç«¯ç‚¹**ï¼š
- `GET /api/admin/images` - é•œåƒç‰ˆæœ¬åˆ—è¡¨
- `POST /api/admin/images/rollback` - å›æ»šé•œåƒç‰ˆæœ¬

---

### 2.11 å®Œå–„éªŒè¯æŠ¥å‘Šç”Ÿæˆ (P1)

**è®¾è®¡è¦æ±‚**ï¼šéªŒè¯æŠ¥å‘Šæ¨¡æ¿.md

**ç°æœ‰é—®é¢˜**ï¼š
- æŠ¥å‘Šä¸åŒ…å« Layer2 ç»“æœ
- æŠ¥å‘Šä¸åŒ…å«æ‰§è¡Œç›‘æ§æŒ‡æ ‡è¯¦æƒ…
- æŠ¥å‘Šä¸åŒ…å«ä»»åŠ¡å®Œæˆè¯¦æƒ…
- æŠ¥å‘Šä¸åŒ…å«ä¾èµ–ä¿¡æ¯

---

## ä¸‰ã€å‰ç«¯ä¿®å¤è¯¦æƒ…

### 3.1 æŠ¥å‘Šè¿”å›æ ¼å¼é€‚é… (P2)

**ç°çŠ¶**ï¼šåç«¯è¿”å› `{content: "...", content_type: "markdown"}`

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `stores/adminSkill.ts` ä¸­é€‚é…æ ¼å¼

```typescript
async fetchSkillReport(skillId: string) {
  const response = await api.get<{content: string; content_type: string}>(
    `/api/admin/skills/${skillId}/report`
  )
  this.currentReport = response.data.content
}
```

---

## å››ã€ä¿®å¤é¡ºåº

```
Day 1 (P0 ç´§æ€¥ - æ•°æ®åº“å’ŒéªŒè¯æµç¨‹):
â”œâ”€â”€ [P0] æ•°æ®åº“æ¨¡å‹è¡¥å…¨ï¼ˆ8ä¸ªå­—æ®µï¼‰
â”œâ”€â”€ [P0] å®ç° MetricsCollector å¯åŠ¨
â”œâ”€â”€ [P0] å®ç°ç¦»çº¿æµ‹è¯•ï¼ˆç½‘ç»œæ–­å¼€ + ç¦»çº¿ç›²æµ‹ï¼‰
â”œâ”€â”€ [P0] å®ç°ç¬¬äºŒå±‚éªŒè¯ï¼ˆLayer2 - å¹¶è¡Œå›å½’æµ‹è¯•ï¼‰
â”œâ”€â”€ [P0] æ·»åŠ  revalidate ç«¯ç‚¹
â”œâ”€â”€ [P0] ä¿®å¤ approve è¿”å›æ ¼å¼
â””â”€â”€ [P0] ä¿®å¤ reject è¿”å›æ ¼å¼

Day 2 (P1 é‡è¦ - API å’Œå‰ç«¯):
â”œâ”€â”€ [P1] è¡¥å…¨ SkillResponse å­—æ®µ
â”œâ”€â”€ [P1] å®ç°åˆ†é¡µ
â”œâ”€â”€ [P1] æ·»åŠ é•œåƒç®¡ç† API
â”œâ”€â”€ [P1] å®Œå–„éªŒè¯æŠ¥å‘Šç”Ÿæˆ
â””â”€â”€ [P2] å‰ç«¯æŠ¥å‘Šæ ¼å¼é€‚é…

Day 3 (æµ‹è¯•):
â””â”€â”€ é›†æˆæµ‹è¯•ï¼ˆé‡ç‚¹æµ‹è¯• Layer2 å¹¶è¡Œå›å½’ï¼‰
```

---

## äº”ã€å¯å¤ç”¨ä»£ç 

### 5.1 å¤ç”¨ `deepagents.middleware.skills._parse_skill_metadata`

```python
from deepagents.middleware.skills import _parse_skill_metadata
```

### 5.2 å¤ç”¨ `create_deep_agent`

```python
from deepagents import create_deep_agent
```

### 5.3 å¤ç”¨ `DockerSandboxBackend`

å·²æœ‰ `disconnect_network()` å’Œ `reconnect_network()` æ–¹æ³•

### 5.4 å¤ç”¨ `MetricsCollector`

```python
from src.agent_skills.skill_metrics import MetricsCollector
```

### 5.5 å¤ç”¨ `skill_image_manager`

```python
from src.agent_skills.skill_image_manager import get_image_backend
```

### 5.6 å¤ç”¨è¯„åˆ†è®¡ç®—å‡½æ•°

```python
from src.agent_skills.skill_metrics import (
    calculate_resource_score,
    calculate_offline_score,
    calculate_trigger_score,
    calculate_completion_score,
    calculate_overall_score
)
```

---

## å…­ã€éªŒè¯æ¸…å•

### 6.1 Layer2 éªŒè¯è¦ç‚¹

1. âœ… `validation_stage` åº”è¯¥ç»å†ï¼š`layer1` â†’ `layer2` â†’ `completed`
2. âœ… `layer2_report` åº”è¯¥åŒ…å«ï¼š
   - `passed`: bool
   - `regression_results`: dictï¼ˆæ¯ä¸ªå·²å…¥åº“ skill çš„ç»“æœï¼‰
   - `total_skills_tested`: int
   - `failed_skills`: list
3. âœ… å›å½’æµ‹è¯•åº”è¯¥å¹¶è¡Œæ‰§è¡Œï¼ˆæŸ¥çœ‹æ—¥å¿—ç¡®è®¤ï¼‰
4. âœ… æ¯ä¸ªå›å½’æµ‹è¯•ä½¿ç”¨ç‹¬ç«‹å®¹å™¨ï¼ˆæŸ¥çœ‹ Docker å®¹å™¨åˆ—è¡¨ï¼‰

### 6.2 ç¦»çº¿æµ‹è¯•éªŒè¯è¦ç‚¹

1. âœ… æ—¥å¿—ä¸­æœ‰ "ç½‘ç»œæ–­å¼€" å’Œ "ç½‘ç»œæ¢å¤" çš„è®°å½•
2. âœ… `offline_capable` æ­£ç¡®åæ˜  skill æ˜¯å¦å¯ç¦»çº¿
3. âœ… `blocked_network_calls` ç»Ÿè®¡è¢«é˜»æ­¢çš„ç½‘ç»œè°ƒç”¨æ¬¡æ•°

### 6.3 æµ‹è¯•å‘½ä»¤

```bash
# 1. è¿è¡Œåç«¯æµ‹è¯•
cd mutil-user-agent-backend
uv run python -m tests.skill_admin.run_all

# 2. æµ‹è¯• revalidate ç«¯ç‚¹
curl -X POST "http://localhost:8002/api/admin/skills/{skill_id}/revalidate" \
  -H "Authorization: Bearer {token}"

# 3. æµ‹è¯• approve è¿”å›æ ¼å¼
curl -X POST "http://localhost:8002/api/admin/skills/{skill_id}/approve" \
  -H "Authorization: Bearer {token}"
# æœŸæœ›è¿”å›: {skill_id, name, status, runtime_image_version, approved_at, message}

# 4. æµ‹è¯• reject è¿”å›æ ¼å¼
curl -X POST "http://localhost:8002/api/admin/skills/{skill_id}/reject" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"reason": "test"}'
# æœŸæœ›è¿”å›: {skill_id, status, rejected_at, reject_reason}

# 5. æµ‹è¯•åˆ†é¡µ
curl "http://localhost:8002/api/admin/skills?page=1&size=10" \
  -H "Authorization: Bearer {token}"
# æœŸæœ›è¿”å›: {skills: [...], total: N, page: 1, size: 10}

# 6. æµ‹è¯•é•œåƒç‰ˆæœ¬
curl "http://localhost:8002/api/admin/images" \
  -H "Authorization: Bearer {token}"
```

---

## ä¸ƒã€æµ‹è¯•ç”¨ä¾‹å¯¹ç…§

æ ¹æ® `æµ‹è¯•ç”¨ä¾‹.md`ï¼Œ**47 ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼š

| ç±»åˆ« | æ€»æ•° | ä¿®å¤åé¢„è®¡é€šè¿‡ |
|------|------|----------------|
| ä¸Šä¼ æµ‹è¯• | 7 | 7 |
| Layer1 æµ‹è¯• | 10 | 10 |
| Layer2 æµ‹è¯• | 5 | 5 |
| é•œåƒç®¡ç† | 5 | 5 |
| å®¡æ‰¹æµ‹è¯• | 5 | 5 |
| æŸ¥è¯¢æµ‹è¯• | 7 | 7 |
| åˆ é™¤æµ‹è¯• | 4 | 4 |
| å¹¶å‘æµ‹è¯• | 4 | 4 |

---

## å…«ã€æ³¨æ„äº‹é¡¹

### 8.1 æ•°æ®åº“è¿ç§»

```bash
# ç›´æ¥é‡å»ºè¡¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
# åˆ é™¤æ•°æ®åº“ä¸­çš„ skills å’Œ image_versions è¡¨ï¼Œé‡å¯æœåŠ¡è‡ªåŠ¨åˆ›å»º
```

### 8.2 Layer2 ç‰¹åˆ«æ³¨æ„

1. **å¹¶å‘æ§åˆ¶**ï¼š
   - Layer1 ä½¿ç”¨å…¨å±€é”ï¼ŒåŒæ—¶åªèƒ½éªŒè¯ä¸€ä¸ªæ–° skill
   - Layer2 çš„å¹¶è¡Œå›å½’æµ‹è¯•ä¸å—å…¨å±€é”é™åˆ¶
   - é™åˆ¶æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®® 5 ä¸ªï¼‰ï¼Œé¿å…èµ„æºè€—å°½

2. **é•œåƒä¾èµ–**ï¼š
   - å½“å‰ç®€åŒ–å®ç°å¯ä»¥ä½¿ç”¨ `settings.DOCKER_IMAGE`ï¼ˆåŸºç¡€é•œåƒï¼‰
   - åç»­è¿­ä»£éœ€è¦å®ç°å¢é‡é•œåƒç®¡ç†

3. **å›å½’æµ‹è¯•å¤±è´¥å¤„ç†**ï¼š
   - Layer2 å¤±è´¥æ—¶ï¼Œskill ä¸ä¼šè¢«è‡ªåŠ¨åˆ é™¤
   - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æŠ¥å‘Šï¼Œå†³å®šæ˜¯å¦è¦æ±‚å¼€å‘è€…ä¿®å¤åé‡æ–°éªŒè¯

### 8.3 æ€§èƒ½ä¼˜åŒ–

- å¦‚æœå·²å…¥åº“ skill å¾ˆå¤šï¼ˆ>10 ä¸ªï¼‰ï¼Œè€ƒè™‘é™åˆ¶å›å½’æµ‹è¯•æ•°é‡
- åœ¨é…ç½®ä¸­æ·»åŠ  `SKILL_REGRESSION_TEST_LIMIT` å‚æ•°

---

*ä¿®å¤è®¡åˆ’ç‰ˆæœ¬ï¼šv2*
*æœ€åæ›´æ–°ï¼š2026-02-19*
