# 数据库设计

> v0.1.9 Skill 验证与管理

---

## 一、表结构变更

### 1.1 User 表修改

**新增字段**:

```python
class User(Base):
    __tablename__ = "users"

    user_id = Column(String(50), primary_key=True)
    username = Column(String(50), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    is_admin = Column(Boolean, default=False)  # 新增
    created_at = Column(DateTime, server_default=func.now())
```

**迁移 SQL**:
```sql
ALTER TABLE users ADD COLUMN is_admin BOOLEAN DEFAULT FALSE;
```

---

### 1.2 Skill 表（新增）

```python
from sqlalchemy import Column, String, DateTime, Boolean, Integer, Float, Text, JSON, ForeignKey
from sqlalchemy.sql import func

class Skill(Base):
    __tablename__ = "skills"

    # ============ 主键 ============
    skill_id = Column(String(50), primary_key=True)
    
    # ============ 基本信息 ============
    name = Column(String(64), unique=True, nullable=False)
    display_name = Column(String(100))
    description = Column(String(1024))
    
    # ============ 状态管理 ============
    status = Column(String(20), default="pending", nullable=False, index=True)
    # pending / validating / approved / rejected / rollback_pending
    
    validation_stage = Column(String(20))  # layer1 / layer2 / completed / failed
    
    # ============ 文件信息 ============
    skill_path = Column(String(255), nullable=False)
    # skills_pending/{name} 或 skills/{name}
    
    # ============ 格式验证结果 ============
    format_valid = Column(Boolean, default=False)
    format_errors = Column(JSON, default=list)
    format_warnings = Column(JSON, default=list)
    
    # ============ 第一层验证结果 ============
    layer1_passed = Column(Boolean, default=False)
    layer1_report = Column(JSON)
    
    # 盲测结果
    blind_test_passed = Column(Boolean, default=False)
    skill_triggered = Column(Boolean, default=False)
    trigger_accuracy = Column(Float)
    
    # 内网验证
    network_test_passed = Column(Boolean, default=False)
    offline_capable = Column(Boolean, default=False)
    blocked_network_calls = Column(Integer, default=0)
    
    # 执行监控
    execution_metrics = Column(JSON)
    
    # 任务结果
    task_results = Column(JSON)
    
    # 第一层评分（混合机制）
    completion_score = Column(Integer)  # LLM Judge 评估
    trigger_accuracy_score = Column(Integer)  # 客观规则
    offline_capability_score = Column(Integer)  # 客观规则
    resource_efficiency_score = Column(Integer)  # 客观规则
    
    # 评分详情
    score_weights = Column(JSON)  # {"completion": 0.4, "trigger": 0.3, ...}
    task_completion_details = Column(JSON)  # 每个任务的 LLM 评估详情
    
    # ============ 第二层验证结果 ============
    layer2_passed = Column(Boolean, default=False)
    layer2_report = Column(JSON)
    
    # 回归测试详情
    regression_results = Column(JSON)
    # {"skill-a": {"passed": true, "score": 85}, ...}
    
    # ============ 总体验证结果 ============
    validation_score = Column(Float)
    validation_report = Column(JSON)
    validated_at = Column(DateTime)
    
    # ============ 依赖信息 ============
    installed_dependencies = Column(JSON)
    # {"pip": {"pandas": "2.0.0"}, "npm": {}, "system": {}}
    
    docker_image = Column(String(255))
    requirements = Column(Text)
    
    # ============ 镜像版本 ============
    runtime_image_version = Column(String(50))
    # 入库时的镜像版本，如 "v1.3"
    
    # ============ 审批信息 ============
    approved_by = Column(String(50), ForeignKey("users.user_id"))
    approved_at = Column(DateTime)
    rejected_by = Column(String(50), ForeignKey("users.user_id"))
    rejected_at = Column(DateTime)
    reject_reason = Column(String(500))
    
    # ============ 元信息 ============
    created_by = Column(String(50), ForeignKey("users.user_id"))
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
```

### 1.3 镜像版本表（新增）

```python
class ImageVersion(Base):
    __tablename__ = "image_versions"

    id = Column(Integer, primary_key=True, autoincrement=True)
    version = Column(String(50), unique=True, nullable=False)  # v1.0, v1.1, ...
    skill_id = Column(String(50), ForeignKey("skills.skill_id"))  # 该版本新增的 skill
    created_at = Column(DateTime, server_default=func.now())
    is_current = Column(Boolean, default=False)  # 是否为当前生产版本
    dependencies_snapshot = Column(JSON)  # 该版本的依赖快照
```

---

## 二、建表 SQL

### 2.1 Skill 表

```sql
CREATE TABLE skills (
    -- 主键
    skill_id VARCHAR(50) PRIMARY KEY,
    
    -- 基本信息
    name VARCHAR(64) UNIQUE NOT NULL,
    display_name VARCHAR(100),
    description VARCHAR(1024),
    
    -- 状态管理
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    validation_stage VARCHAR(20),
    
    -- 文件信息
    skill_path VARCHAR(255) NOT NULL,
    
    -- 格式验证结果
    format_valid BOOLEAN DEFAULT FALSE,
    format_errors JSONB DEFAULT '[]',
    format_warnings JSONB DEFAULT '[]',
    
    -- 第一层验证结果
    layer1_passed BOOLEAN DEFAULT FALSE,
    layer1_report JSONB,
    
    -- 盲测结果
    blind_test_passed BOOLEAN DEFAULT FALSE,
    skill_triggered BOOLEAN DEFAULT FALSE,
    trigger_accuracy FLOAT,
    
    -- 内网验证
    network_test_passed BOOLEAN DEFAULT FALSE,
    offline_capable BOOLEAN DEFAULT FALSE,
    blocked_network_calls INTEGER DEFAULT 0,
    
    -- 执行监控
    execution_metrics JSONB,
    
    -- 任务结果
    task_results JSONB,
    
    -- 第一层评分（混合机制）
    completion_score INTEGER,  -- LLM Judge 评估
    trigger_accuracy_score INTEGER,  -- 客观规则
    offline_capability_score INTEGER,  -- 客观规则
    resource_efficiency_score INTEGER,  -- 客观规则
    
    -- 评分详情
    score_weights JSONB,  -- 权重配置
    task_completion_details JSONB,  -- LLM 评估详情
    
    -- 第二层验证结果
    layer2_passed BOOLEAN DEFAULT FALSE,
    layer2_report JSONB,
    
    -- 回归测试
    regression_results JSONB,
    
    -- 总体验证结果
    validation_score FLOAT,
    validation_report JSONB,
    validated_at TIMESTAMP,
    
    -- 依赖信息
    installed_dependencies JSONB,
    docker_image VARCHAR(255),
    requirements TEXT,
    
    -- 镜像版本
    runtime_image_version VARCHAR(50),
    
    -- 审批信息
    approved_by VARCHAR(50) REFERENCES users(user_id),
    approved_at TIMESTAMP,
    rejected_by VARCHAR(50) REFERENCES users(user_id),
    rejected_at TIMESTAMP,
    reject_reason VARCHAR(500),
    
    -- 元信息
    created_by VARCHAR(50) REFERENCES users(user_id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_skills_status ON skills(status);
CREATE INDEX idx_skills_name ON skills(name);
CREATE INDEX idx_skills_created_at ON skills(created_at DESC);
CREATE INDEX idx_skills_validation_stage ON skills(validation_stage);

-- 约束
ALTER TABLE skills 
ADD CONSTRAINT chk_status 
CHECK (status IN ('pending', 'validating', 'approved', 'rejected', 'rollback_pending'));

ALTER TABLE skills 
ADD CONSTRAINT chk_validation_stage 
CHECK (validation_stage IS NULL OR validation_stage IN ('layer1', 'layer2', 'completed', 'failed'));

ALTER TABLE skills 
ADD CONSTRAINT chk_scores 
CHECK (
    (completion_score IS NULL OR (completion_score >= 0 AND completion_score <= 100)) AND
    (trigger_accuracy_score IS NULL OR (trigger_accuracy_score >= 0 AND trigger_accuracy_score <= 100)) AND
    (offline_capability_score IS NULL OR (offline_capability_score >= 0 AND offline_capability_score <= 100)) AND
    (resource_efficiency_score IS NULL OR (resource_efficiency_score >= 0 AND resource_efficiency_score <= 100))
);
```

### 2.2 ImageVersion 表

```sql
CREATE TABLE image_versions (
    id SERIAL PRIMARY KEY,
    version VARCHAR(50) UNIQUE NOT NULL,
    skill_id VARCHAR(50) REFERENCES skills(skill_id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_current BOOLEAN DEFAULT FALSE,
    dependencies_snapshot JSONB
);

CREATE INDEX idx_image_versions_current ON image_versions(is_current);
```

---

## 三、字段说明

### 3.1 状态字段

| 字段 | 值 | 说明 |
|------|-----|------|
| `status` | `pending` | 待审批 |
| | `validating` | 验证中 |
| | `approved` | 已批准入库 |
| | `rejected` | 已拒绝 |
| | `rollback_pending` | 回滚待处理 |
| `validation_stage` | `layer1` | 第一层验证进行中 |
| | `layer2` | 第二层验证进行中 |
| | `completed` | 验证完成 |
| | `failed` | 验证失败 |

### 3.2 验证结果字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `layer1_passed` | Boolean | 第一层验证是否通过 |
| `layer2_passed` | Boolean | 第二层验证是否通过 |
| `blind_test_passed` | Boolean | 盲测是否通过（3个任务全部正确） |
| `skill_triggered` | Boolean | Agent 是否自主使用了该 skill |
| `trigger_accuracy` | Float | 触发准确率（0.0-1.0） |
| `network_test_passed` | Boolean | 内网测试是否通过 |
| `offline_capable` | Boolean | 是否可离线运行 |
| `blocked_network_calls` | Integer | 被阻止的网络调用次数 |

### 3.3 评分字段

| 字段 | 范围 | 权重 | 评分方式 | 说明 |
|------|------|------|----------|------|
| `completion_score` | 0-100 | 40% | LLM Judge | 任务完成度（5级制转换） |
| `trigger_accuracy_score` | 0-100 | 30% | 客观规则 | 触发准确性 |
| `offline_capability_score` | 0-100 | 20% | 客观规则 | 离线能力 |
| `resource_efficiency_score` | 0-100 | 10% | 客观规则 | 资源效率 |
| `validation_score` | 0-100 | - | 加权平均 | 总体评分 |

### 3.4 JSON 字段结构

#### layer1_report
```json
{
  "online_blind_test": {
    "passed": true,
    "skill_triggered": true,
    "trigger_accuracy": 1.0,
    "task_results": [...]
  },
  "offline_blind_test": {
    "passed": true,
    "skill_triggered": true,
    "trigger_accuracy": 1.0,
    "task_results": [...]
  },
  "network_test": {
    "passed": true,
    "blocked_network_calls": 0,
    "offline_capable": true
  },
  "execution_metrics": {...},
  "scores": {
    "completion_score": 80.0,
    "trigger_score": 100.0,
    "offline_score": 100,
    "resource_score": 75,
    "overall": 89.5,
    "weights": {
      "completion": 0.40,
      "trigger": 0.30,
      "offline": 0.20,
      "resource": 0.10
    },
    "calculation_method": "hybrid"
  },
  "task_completion_details": [
    {
      "task": "任务描述",
      "llm_score": 4,
      "converted_score": 75,
      "reason": "评估理由"
    }
  ],
  "summary": "...",
  "strengths": [...],
  "weaknesses": [...],
  "recommendations": [...]
}
```

#### layer2_report
```json
{
  "passed": true,
  "regression_results": {
    "skill-a": {"passed": true, "score": 85},
    "skill-b": {"passed": true, "score": 90}
  },
  "total_skills_tested": 2,
  "failed_skills": []
}
```

#### execution_metrics
```json
{
  "cpu_percent": 15.2,
  "memory_mb": 128.0,
  "disk_read_mb": 2.5,
  "disk_write_mb": 1.2,
  "execution_time_sec": 45.0
}
```

#### task_results
```json
[
  {
    "task": "分析 data.csv 文件",
    "completed": true,
    "skill_used": "csv-analyzer",
    "correct_skill_used": true,
    "execution_time_ms": 2340,
    "output_summary": "...",
    "llm_evaluation": {
      "raw_score": 4,
      "converted_score": 75,
      "analysis": "任务要求分析...",
      "requirements_met": ["要求1", "要求2"],
      "requirements_missed": [],
      "reason": "完成良好，有轻微格式问题"
    }
  }
]
```

#### regression_results
```json
{
  "skill-a": {
    "passed": true,
    "score": 85,
    "tasks_completed": 3,
    "error": null
  },
  "skill-b": {
    "passed": false,
    "score": 40,
    "tasks_completed": 1,
    "error": "numpy 版本冲突"
  }
}
```

#### installed_dependencies

基于命令历史对比记录 Agent 执行的安装操作：

```json
{
  "new_commands": [
    "pip install pandas numpy",
    "curl -O https://example.com/data.csv",
    "apt-get update && apt-get install -y ffmpeg"
  ],
  "dependencies": {
    "pip": ["pip install pandas numpy"],
    "apt": ["apt-get update && apt-get install -y ffmpeg"],
    "npm": [],
    "downloaded": ["curl -O https://example.com/data.csv"],
    "other_install": [],
    "raw_commands": ["完整命令列表..."]
  },
  "total_new_commands": 3,
  "recorded_at": "2026-02-16T10:00:00Z"
}
```

---

## 四、索引设计

| 索引名 | 表 | 字段 | 类型 | 说明 |
|--------|-----|------|------|------|
| `idx_skills_status` | skills | status | B-tree | 按状态过滤 |
| `idx_skills_name` | skills | name | B-tree | 名称查询 |
| `idx_skills_created_at` | skills | created_at | B-tree | 时间排序 |
| `idx_skills_validation_stage` | skills | validation_stage | B-tree | 按验证阶段过滤 |
| `idx_image_versions_current` | image_versions | is_current | B-tree | 查询当前版本 |

---

## 五、查询示例

### 5.1 获取待审批列表

```python
with SessionLocal() as db:
    skills = db.query(Skill)\
        .filter(Skill.status == "pending")\
        .filter(Skill.validation_stage == "completed")\
        .order_by(Skill.created_at.desc())\
        .offset((page - 1) * size)\
        .limit(size)\
        .all()
```

### 5.2 获取已批准 Skill（Agent 使用）

```python
with SessionLocal() as db:
    skills = db.query(Skill)\
        .filter(Skill.status == "approved")\
        .all()
```

### 5.3 获取当前生产镜像版本

```python
with SessionLocal() as db:
    current = db.query(ImageVersion)\
        .filter(ImageVersion.is_current == True)\
        .first()
    return current.version  # "v1.3"
```

### 5.4 获取低分 Skill

```python
with SessionLocal() as db:
    low_score_skills = db.query(Skill)\
        .filter(Skill.validation_score < 70)\
        .filter(Skill.status == "pending")\
        .all()
```

### 5.5 获取回归失败的 Skill

```python
with SessionLocal() as db:
    failed = db.query(Skill)\
        .filter(Skill.layer2_passed == False)\
        .filter(Skill.validation_stage == "failed")\
        .all()
```

### 5.6 获取某个镜像版本之后入库的 Skill

```python
with SessionLocal() as db:
    version = db.query(ImageVersion).filter(ImageVersion.version == "v1.2").first()
    skills = db.query(Skill)\
        .filter(Skill.runtime_image_version > "v1.2")\
        .all()
```

---

## 六、ER 图

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│     users       │       │     skills      │       │ image_versions  │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ user_id (PK)    │◄──────│ approved_by(FK) │       │ id (PK)         │
│ username        │       │ rejected_by(FK) │       │ version         │
│ password_hash   │       │ created_by(FK)  │──────▶│ skill_id (FK)   │
│ is_admin        │       │                 │       │ is_current      │
│ created_at      │       │ skill_id (PK)   │       │ dependencies_   │
└─────────────────┘       │ name            │       │   snapshot      │
                          │ status          │       └─────────────────┘
                          │ validation_stage│
                          │ skill_path      │
                          │ layer1_passed   │
                          │ layer2_passed   │
                          │ blind_test_*    │
                          │ network_test_*  │
                          │ execution_*     │
                          │ *_score         │
                          │ runtime_image_  │
                          │   version       │
                          └─────────────────┘
```
