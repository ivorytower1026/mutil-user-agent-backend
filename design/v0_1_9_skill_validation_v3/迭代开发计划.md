# 迭代开发计划

> v0.1.9 Skill 验证与管理

---

## 一、整体规划

### 1.1 迭代目标

实现 Agent Skill 的完整生命周期管理：上传 → 验证 → 审批 → 入库

### 1.2 开发周期

**总计：约 4 天**

| 阶段 | 内容 | 预计时间 | 依赖 |
|------|------|----------|------|
| Phase 1 | 数据库模型 + 迁移 + 格式验证 | 0.5天 | 无 |
| Phase 2 | 第一层验证（单独验证） | 1天 | Phase 1 |
| Phase 3 | 第二层验证（并行回归） | 1天 | Phase 2 |
| Phase 4 | 增量镜像管理 | 0.5天 | Phase 3 |
| Phase 5 | Skill 管理器 + Admin API | 0.5天 | Phase 4 |
| Phase 6 | 集成测试 | 0.5天 | Phase 5 |

---

## 二、Phase 1：数据库模型 + 迁移

### 2.1 目标

- User 表新增 `is_admin` 字段
- 新建 Skill 表
- 新建 ImageVersion 表

### 2.2 文件变更

```
src/database.py  # 修改
```

### 2.3 具体任务

**Task 1-1**：修改 User 表
```python
class User(Base):
    # 新增字段
    is_admin = Column(Boolean, default=False)
```

**Task 1-2**：创建 Skill 表
```python
class Skill(Base):
    __tablename__ = "skills"
    # 完整字段定义见数据库设计.md
```

**Task 1-3**：创建 ImageVersion 表
```python
class ImageVersion(Base):
    __tablename__ = "image_versions"
    # 完整字段定义见数据库设计.md
```

**Task 1-4**：数据库迁移
```python
# 在 create_tables() 中自动创建
# 或手动执行 SQL 迁移脚本
```

**Task 1-5**：格式验证（复用 DeepAgents）
```python
from deepagents.middleware.skills import _parse_skill_metadata

def validate_skill_format(skill_path: str) -> tuple[bool, list[str], list[str]]:
    """复用 DeepAgents 的验证逻辑"""
    skill_md_path = os.path.join(skill_path, "SKILL.md")
    
    # 1. 检查 SKILL.md 存在
    if not os.path.exists(skill_md_path):
        return False, ["Missing SKILL.md"], []
    
    # 2. 读取并解析
    with open(skill_md_path, encoding='utf-8') as f:
        content = f.read()
    
    # 3. 复用 DeepAgents 的解析逻辑
    directory_name = os.path.basename(skill_path)
    metadata = _parse_skill_metadata(content, skill_md_path, directory_name)
    
    if metadata is None:
        return False, ["Invalid frontmatter format or missing name/description"], []
    
    return True, [], []
```

### 2.4 验收标准

- [ ] User 表包含 is_admin 字段
- [ ] Skill 表创建成功，包含所有字段
- [ ] ImageVersion 表创建成功
- [ ] 索引和约束正确创建
- [ ] 格式验证复用 DeepAgents 逻辑
- [ ] 缺少 SKILL.md 时返回错误

### 2.5 测试

```python
def test_database_models():
    # 测试 User
    user = User(user_id="admin", username="admin", is_admin=True)
    
    # 测试 Skill
    skill = Skill(skill_id="test", name="test-skill", status="pending")
    
    # 测试 ImageVersion
    version = ImageVersion(version="v1.0", is_current=True)

def test_format_validation():
    # 测试有效 skill
    passed, errors, warnings = validate_skill_format("valid-skill/")
    assert passed == True
    
    # 测试缺少 SKILL.md
    passed, errors, warnings = validate_skill_format("no-md-skill/")
    assert passed == False
    assert "SKILL.md" in errors[0]
```

---

## 三、Phase 2：第一层验证（复用现有代码）

### 3.1 目标

- 实现双 Agent 验证机制（复用 create_deep_agent）
- 实现 Agent 自主安装依赖 + 断网测试（扩展 DockerSandboxBackend）
- 实现盲测机制
- 采集执行监控指标
- 实现报告生成子 Agent

### 3.2 文件变更

```
src/skill_agent_validator.py  # 新增（核心）
src/skill_metrics.py          # 新增
src/docker_sandbox.py         # 修改（添加网络控制方法）
```

### 3.3 具体任务

**Task 2-1**：创建验证编排器
```python
from src.docker_sandbox import DockerSandboxBackend

class ValidationOrchestrator:
    def __init__(self):
        self.validation_lock = asyncio.Lock()
        self.metrics_collector = MetricsCollector()
        self.report_generator = ReportGeneratorAgent()
    
    async def validate_layer1(self, skill_id: str) -> Layer1Result:
        pass
```

**Task 2-2**：实现动态网络控制（扩展 DockerSandboxBackend）
```python
# 在 src/docker_sandbox.py 中添加方法
class DockerSandboxBackend:
    # 现有代码保持不变...
    
    def disconnect_network(self) -> bool:
        """断开容器网络"""
        if self._container:
            self.client.networks.get("bridge").disconnect(self._container)
            return True
        return False
```

**Task 2-3**：实现验证 Agent（复用 create_deep_agent）
```python
from deepagents import create_deep_agent

class ValidationAgents:
    def __init__(self, backend: DockerSandboxBackend):
        self.validation_agent = create_deep_agent(
            model=big_llm,
            backend=lambda _: backend,
            system_prompt="..."
        )
```

**Task 2-4**：实现执行 Agent 包装器（复用 create_deep_agent）
```python
class ExecutionAgentWrapper:
    def __init__(self, backend: DockerSandboxBackend):
        self.execution_agent = create_deep_agent(
            model=big_llm,
            backend=lambda _: backend,
            system_prompt="..."  # 包含联网安装依赖的能力
        )
    
    async def execute_task(self, task: str) -> TaskResult:
        pass
```

**Task 2-5**：实现监控采集
```python
class MetricsCollector:
    async def collect(self, container_id: str) -> ExecutionMetrics:
        # 采集 CPU/内存/IO/时间
        pass
```

**Task 2-6**：实现报告生成子 Agent
```python
class ReportGeneratorAgent:
    """验证报告生成子 Agent"""
    
    def __init__(self):
        self.agent = create_deep_agent(
            model=flash_llm,
            system_prompt="""你是 Skill 验证报告生成专家。
            根据验证结果数据，生成 Markdown 格式的验证报告。
            参考"验证报告模板.md"的格式。"""
        )
    
    async def generate(self, validation_data: dict) -> str:
        """生成 Markdown 验证报告"""
        pass
```

### 3.4 验收标准

- [ ] Agent 自主安装依赖（无需专门分析）
- [ ] 断网阶段成功执行测试
- [ ] 盲测机制正常工作
- [ ] 监控指标正确采集
- [ ] 报告生成子 Agent 生成 Markdown 报告

### 3.5 测试

```python
def test_layer1_validation():
    result = await orchestrator.validate_layer1(skill_id)
    
    assert result.passed in [True, False]
    assert result.blind_test.trigger_accuracy >= 0
    assert result.execution_metrics.cpu_percent >= 0

def test_report_generation():
    report = await report_generator.generate(validation_data)
    assert report.startswith("# Skill 验证报告")
```

---

## 四、Phase 3：第二层验证（并行回归）

### 4.1 目标

- 实现并行回归测试
- 复用已安装依赖的容器/镜像
- 汇总回归结果

### 4.2 文件变更

```
src/skill_agent_validator.py  # 扩展
```

### 4.3 具体任务

**Task 3-1**：实现并行回归测试
```python
async def validate_layer2_parallel(
    container, 
    approved_skills: list[str]
) -> Layer2Result:
    """并行回归测试所有已入库 skill"""
    
    # 创建并行任务
    tasks = [
        test_single_skill_regression(container, skill)
        for skill in approved_skills
    ]
    
    # 并行执行
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    return aggregate_results(results)
```

**Task 3-2**：单个 skill 回归测试
```python
async def test_single_skill_regression(
    container, 
    skill_name: str
) -> RegressionResult:
    """测试单个 skill（使用同一容器）"""
    
    # 1. 读取 skill 的 SKILL.md
    skill_md = read_skill_md(skill_name)
    
    # 2. 生成测试任务
    tasks = await validation_agent.generate_tasks(skill_md)
    
    # 3. 执行测试
    results = []
    for task in tasks:
        result = await execution_agent.execute_task(container, task)
        results.append(result)
    
    return RegressionResult(
        skill_name=skill_name,
        passed=all(r.completed for r in results),
        score=calculate_score(results)
    )
```

**Task 3-3**：结果汇总
```python
def aggregate_results(results: list) -> Layer2Result:
    """汇总所有回归结果"""
    
    passed = all(
        r.passed if not isinstance(r, Exception) else False 
        for r in results
    )
    
    failed_skills = [
        skill for skill, r in zip(skills, results)
        if isinstance(r, Exception) or not r.passed
    ]
    
    return Layer2Result(
        passed=passed,
        regression_results=...,
        failed_skills=failed_skills
    )
```

### 4.4 验收标准

- [ ] 回归测试并行执行
- [ ] 每个 skill 独立测试
- [ ] 正确汇总所有结果
- [ ] 记录失败的 skill

### 4.5 测试

```python
def test_layer2_parallel():
    # 模拟 3 个已入库 skill
    result = await orchestrator.validate_layer2(container, ["a", "b", "c"])
    
    assert result.total_skills_tested == 3
    assert isinstance(result.regression_results, dict)
```

---

## 五、Phase 4：增量镜像管理

### 5.1 目标

- 实现镜像版本管理
- 实现 commit 新版本
- 实现清理旧版本
- 实现回滚机制

### 5.2 文件变更

```
src/skill_image_manager.py  # 新增
```

### 5.3 具体任务

**Task 4-1**：创建镜像管理器
```python
class SkillImageManager:
    def __init__(self):
        self.prefix = settings.SKILL_RUNTIME_IMAGE_PREFIX
        self.max_versions = settings.SKILL_IMAGE_VERSIONS_TO_KEEP
    
    def get_current_image(self) -> str:
        pass
    
    def commit_new_version(self, container_id: str) -> str:
        pass
    
    def rollback(self, target_version: str) -> list[str]:
        pass
```

**Task 4-2**：commit 新版本
```python
def commit_new_version(self, container_id: str) -> str:
    new_version = self._get_next_version()
    
    container = self.client.containers.get(container_id)
    container.commit(repository=self.prefix, tag=new_version)
    
    self._cleanup_old_versions()
    self._update_current_version(new_version)
    
    return f"{self.prefix}:{new_version}"
```

**Task 4-3**：清理旧版本
```python
def _cleanup_old_versions(self):
    versions = self._list_all_versions()
    if len(versions) > self.max_versions:
        for v in versions[:-self.max_versions]:
            self.client.images.remove(f"{self.prefix}:{v}")
```

**Task 4-4**：回滚机制
```python
def rollback(self, target_version: str) -> list[str]:
    # 1. 验证目标版本存在
    # 2. 更新当前版本
    # 3. 标记受影响的 skill
    # 4. 返回受影响 skill 列表
    pass
```

### 5.4 验收标准

- [ ] commit 正确创建新版本
- [ ] 旧版本正确清理（保留 5 个）
- [ ] 回滚功能正常
- [ ] 受影响的 skill 被正确标记

### 5.5 测试

```python
def test_image_manager():
    # 测试版本递增
    v1 = manager.get_current_version()
    manager.commit_new_version(container_id)
    v2 = manager.get_current_version()
    assert v2 > v1
    
    # 测试清理旧版本
    # ...
```

---

## 六、Phase 5：Skill 管理器 + Admin API

### 6.1 目标

- 实现 Skill CRUD
- 实现状态流转
- 实现文件操作
- 实现 Admin API 端点

### 6.2 文件变更

```
src/skill_manager.py  # 新增
api/admin.py          # 新增
api/models.py         # 修改
main.py               # 修改（注册路由）
```

### 6.3 具体任务

**Task 5-1**：创建 Skill 管理器
```python
class SkillManager:
    async def upload(self, file: UploadFile, admin_id: str) -> Skill:
        pass
    
    async def approve(self, skill_id: str, admin_id: str) -> Skill:
        pass
    
    async def reject(self, skill_id: str, admin_id: str, reason: str) -> Skill:
        pass
    
    async def delete(self, skill_id: str) -> bool:
        pass
```

**Task 5-2**：实现状态流转
```python
def can_transition(current: str, target: str) -> bool:
    transitions = {
        "pending": ["validating", "approved", "rejected"],
        "validating": ["pending", "rejected"],
        "approved": ["deleted"],
        "rejected": ["validating", "deleted"],
    }
    return target in transitions.get(current, [])
```

**Task 5-3**：创建 Admin API
```python
# api/admin.py

router = APIRouter(prefix="/api/admin", tags=["admin"])

@router.post("/skills/upload")
async def upload_skill(file: UploadFile, admin: str = Depends(get_admin_user)):
    pass

@router.post("/skills/{skill_id}/approve")
async def approve_skill(skill_id: str, admin: str = Depends(get_admin_user)):
    pass

# ... 其他端点
```

**Task 5-4**：添加 Pydantic 模型
```python
# api/models.py

class SkillListItem(BaseModel):
    ...

class ValidationReport(BaseModel):
    ...
```

### 6.4 验收标准

- [ ] 所有 API 端点正常工作
- [ ] 权限验证正确
- [ ] 状态流转正确
- [ ] 文件操作正确

### 6.5 测试

```python
def test_admin_api():
    # 测试上传
    resp = client.post("/api/admin/skills/upload", files=...)
    assert resp.status_code == 200
    
    # 测试批准
    resp = client.post(f"/api/admin/skills/{skill_id}/approve")
    assert resp.status_code == 200
```

---

## 七、Phase 6：集成测试

### 7.1 目标

- 端到端测试
- 性能测试
- 回归测试

### 7.2 文件变更

```
tests/test_skills_api.py  # 新增
```

### 7.3 具体任务

**Task 6-1**：上传流程测试
```python
def test_upload_flow():
    # 上传 → 等待验证 → 查看报告 → 批准
    pass
```

**Task 6-2**：验证流程测试
```python
def test_validation_flow():
    # 第一层 → 第二层 → 报告生成
    pass
```

**Task 6-3**：并行回归测试
```python
def test_parallel_regression():
    # 多个 skill 并行回归
    pass
```

**Task 6-4**：镜像管理测试
```python
def test_image_management():
    # 版本递增 → 清理 → 回滚
    pass
```

### 7.4 验收标准

- [ ] 所有测试用例通过
- [ ] 覆盖率 > 80%
- [ ] 无回归问题

---

## 九、每日进度跟踪

### Day 1

| 任务 | 预计 | 实际 | 状态 |
|------|------|------|------|
| Phase 1: 数据库模型 + 格式验证 | 0.5天 | - | pending |

### Day 2

| 任务 | 预计 | 实际 | 状态 |
|------|------|------|------|
| Phase 2: 第一层验证 | 1天 | - | pending |

### Day 3

| 任务 | 预计 | 实际 | 状态 |
|------|------|------|------|
| Phase 3: 第二层验证（并行回归） | 1天 | - | pending |

### Day 4

| 任务 | 预计 | 实际 | 状态 |
|------|------|------|------|
| Phase 4: 增量镜像管理 | 0.5天 | - | pending |
| Phase 5: 管理器 + API | 0.5天 | - | pending |

### Day 5

| 任务 | 预计 | 实际 | 状态 |
|------|------|------|------|
| Phase 6: 集成测试 | 0.5天 | - | pending |
| 缓冲时间 | 0.5天 | - | pending |

---

## 十、风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Docker 网络控制不稳定 | 高 | 中 | 添加重试机制，记录详细日志 |
| 并行回归资源消耗大 | 中 | 中 | 限制并发数，添加资源监控 |
| Agent 依赖安装失败 | 中 | 低 | Agent 智能重试，支持手动干预 |
| 镜像 commit 失败 | 高 | 低 | 保留容器快照，支持手动恢复 |
| 报告生成 Agent 输出不稳定 | 低 | 中 | 提供详细模板，多次生成取最佳 |

---

## 十一、发布检查清单

### 功能检查

- [ ] 管理员可上传 Skill zip
- [ ] 格式验证正确
- [ ] 第一层验证正常
- [ ] 第二层并行回归正常
- [ ] 验证报告完整
- [ ] 批准/拒绝功能正常
- [ ] 镜像版本管理正常
- [ ] 回滚功能正常

### 性能检查

- [ ] 单个 skill 验证时间 < 5 分钟
- [ ] 并行回归效率提升
- [ ] 内存占用合理

### 安全检查

- [ ] 权限验证正确
- [ ] 无敏感信息泄露
- [ ] Docker 沙箱隔离有效

### 文档检查

- [ ] API 文档完整
- [ ] 部署文档完整
- [ ] 运维文档完整
