# 四件套分析

> v0.1.9 Skill 验证与管理

---

## 一、现象（实际）

### 1.1 已有能力

| 能力 | 实现位置 | 说明 |
|------|----------|------|
| Docker 沙箱容器管理 | `src/docker_sandbox.py` | 容器创建、执行命令、销毁 |
| `/skills` 目录只读挂载 | `src/docker_sandbox.py:177-178` | 全局 Skill 共享 |
| DeepAgents 框架集成 | `src/agent_manager.py` | `create_deep_agent` 创建 Agent |
| 用户认证 + JWT | `src/auth.py` | Token 验证 |
| Agent 流式对话 | `src/agent_manager.py` | DeepAgents + LangGraph |
| 分块上传机制 | `src/chunk_upload.py` | 支持大文件上传 |

### 1.2 当前缺失

| 缺失项 | 影响 |
|--------|------|
| ❌ 无 Skill zip 上传 API | 管理员无法上传新 Skill |
| ❌ 无 Skill 数据库持久化 | 只有文件系统，无状态管理 |
| ❌ 无双 Agent 验证机制 | 无法动态测试 Skill 能力 |
| ❌ 无内网验证能力 | 无法验证离线可用性 |
| ❌ 无增量镜像管理 | 新 Skill 可能破坏已有能力 |
| ❌ 无回归测试机制 | 依赖冲突无法提前发现 |
| ❌ 无管理员角色区分 | 所有用户权限相同 |

### 1.3 业界参考

| 来源 | 验证方式 | 自动化程度 |
|------|----------|------------|
| Anthropic Skills API | frontmatter 格式检查 | 低 |
| OpenAI Skills API | 格式验证 | 低 |
| agentskills.io 规范 | 结构规范定义 | 低 |
| npm/yarn 包管理 | 依赖解析 + 测试脚本 | 中 |
| Docker Hub | 镜像构建 + 自动测试 | 中 |
| **本项目** | **格式验证 + 双 Agent 动态测试 + 回归验证** | **高** |

---

## 二、意图（期望）

### 2.1 核心目标

1. **上传与管理**
   - 管理员上传 **zip 压缩包**（含 SKILL.md + 辅助文件）
   - 自动格式验证（frontmatter + 目录结构）

2. **双 Agent 验证**
   - **验证 Agent**：生成测试任务、评估结果、生成报告
   - **执行 Agent**：盲测执行（不被告知用哪个 skill）

3. **两层验证流程**
   - **第一层**：单独验证（盲测 + 内网 + 监控）
   - **第二层**：并行回归验证（全量测试已有 skill）

4. **内网验证**
   - 联网安装依赖 → 断网执行测试
   - 检测离线可用性

5. **增量镜像管理**
   - 每次入库 commit 新镜像版本
   - 保留最近 5 个版本，支持回滚

6. **人工审批**
   - 验证完成后，管理员查看报告决定是否入库
   - 只有 `approved` 的 Skill 对 Agent 可用

### 2.2 验收标准

- [ ] 管理员可上传 skill zip 包
- [ ] 上传后自动触发第一层验证
- [ ] 格式验证：SKILL.md 存在 + frontmatter 合法
- [ ] 第一层验证：盲测 + 内网验证 + 监控采集
- [ ] 第二层验证：并行回归测试
- [ ] 验证报告包含：清晰度/完整性/可操作性/触发准确性评分
- [ ] 状态流转：pending → validating → completed(等待审核) → approved/rejected
- [ ] 只有 approved 的 Skill 挂载到 /skills/
- [ ] 同时只能验证一个 Skill（全局锁）
- [ ] 镜像版本管理：入库后 commit，保留 5 个版本

### 2.3 用户体验

**管理员视角：**
```
1. 准备 Skill zip 包（SKILL.md + 辅助脚本）
2. POST /api/admin/skills/upload
3. 等待自动验证完成（异步，两层验证）
4. GET /api/admin/skills/{id}/report 查看报告
5. 根据报告决定：
   - POST /api/admin/skills/{id}/approve 批准
   - POST /api/admin/skills/{id}/reject 拒绝
6. 批准后 Skill 立即可用于 Agent
```

**Agent 视角：**
```
1. 在 /skills/ 目录下看到所有 approved 的 Skill
2. 读取 SKILL.md 获取指令
3. 执行辅助脚本（如有）
```

---

## 三、情境（环境约束）

### 3.1 技术栈约束

| 约束项 | 说明 |
|--------|------|
| Python 版本 | 3.13+ |
| Web 框架 | FastAPI |
| ORM | SQLAlchemy |
| 数据库 | PostgreSQL |
| Agent 框架 | DeepAgents + LangGraph |
| 沙箱 | Docker（DockerSandboxBackend） |
| LLM | 智谱 glm-5（big_llm） |

### 3.2 文件系统约束

```
{SHARED_DIR}/
├── skills/                      # 正式目录（仅 approved）
│   └── approved-skill/
│       ├── SKILL.md
│       ├── requirements.txt     # 可选
│       └── scripts/             # 可选
│
└── skills_pending/              # 临时目录（pending/rejected）
    ├── pending-skill-1/
    │   └── SKILL.md
    └── rejected-skill-2/
        └── SKILL.md
```

### 3.3 Docker 网络约束

**问题**：现有 `DockerSandboxBackend` 在创建容器时指定网络模式，不支持动态切换。

**解决方案**：使用 Docker SDK 动态控制网络

```python
# 方案：单容器 + 动态断网
# 1. 创建容器（网络正常）
container = client.containers.create(...)

# 2. 联网安装依赖
container.exec_run("pip install -r requirements.txt")

# 3. 动态断开网络
client.networks.get("bridge").disconnect(container)

# 4. 执行离线测试
container.exec_run("...")

# 5. 销毁容器
container.remove(force=True)
```

### 3.4 并发约束

| 约束 | 说明 |
|------|------|
| 第一层验证 | 全局锁，同时只验证 1 个 Skill |
| 第二层回归 | 并行执行，每个 skill 独立容器 |
| 上传/查询/删除 | 无并发限制 |
| 审批操作 | 无并发限制 |

### 3.5 验证环境约束

| 约束 | 说明 |
|------|------|
| 验证镜像 | 使用 `settings.DOCKER_IMAGE` |
| Skill 挂载位置 | `/skills/`（只读）、`/skill_under_test/`（只读） |
| 依赖安装 | 联网阶段执行（pip/npm/apt/脚本） |
| 容器生命周期 | 验证完成后立即销毁 |

### 3.6 安全约束

| 约束 | 说明 |
|------|------|
| 管理员权限 | 只有 is_admin=True 的用户可操作 |
| Skill 名称唯一 | 不允许重名 |
| 脚本安全检查 | 检测危险模式（rm -rf / 等） |

---

## 四、边界（明确不做）

### 4.1 本迭代不做

| 不做项 | 原因 | 后续迭代 |
|--------|------|----------|
| Skill 版本管理 | 过度设计 | v0.2.x |
| Skill 专用镜像构建 | 复杂度高 | v0.2.x |
| 镜像导出/导入 | 属于内网部署 | v0.2.x |
| 前端管理界面 | 本迭代专注后端 | 前端迭代 |
| 自动审批 | 必须人工确认 | 不做 |
| 批量操作 | 非核心需求 | 不做 |
| Skill 在线编辑 | 风险高 | 不做 |
| 用户私有 Skill | MVP 只做全局共享 | v0.3.x |

### 4.2 明确排除的场景

1. **Skill 热更新**：已 approved 的 Skill 更新需重新上传验证
2. **多租户 Skill**：所有用户共享同一份 approved skills
3. **Skill 依赖解析**：不自动解析 Skill 间的依赖关系
4. **自动触发审批**：即使评分 100 分也需人工确认

### 4.3 技术边界

| 边界 | 说明 |
|------|------|
| 最大 zip 大小 | 50MB |
| 最大文件数量 | 500 个 |
| 验证超时 | 动态计算（基础 5 分钟 + 每个 skill 1 分钟） |
| 历史镜像保留 | 最近 5 个版本 |

---

## 五、关键设计决策

### 5.1 内网验证实现方案

**决策：单容器 + 动态断网**

```
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 1：联网安装依赖                                             │
│ ─────────────────────────────────────────────────────────────── │
│ - 创建容器（网络正常）                                           │
│ - Agent 分析依赖                                                │
│ - pip/npm/apt 安装                                              │
│ - 执行下载脚本                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ docker network disconnect
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 2：断网执行测试                                             │
│ ─────────────────────────────────────────────────────────────── │
│ - 容器网络已断开                                                 │
│ - 执行 Agent 执行任务                                           │
│ - 检测网络调用（被阻止）                                         │
│ - 验证离线可用性                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**实现代码**：
```python
async def validate_skill_with_network_control(skill_id: str):
    # 1. 创建容器（网络正常）
    container = client.containers.create(
        image=settings.DOCKER_IMAGE,
        command="sleep infinity",
        volumes={...}
    )
    container.start()
    
    try:
        # 2. 联网安装依赖
        await install_dependencies(container, skill_path)
        
        # 3. 断开网络
        client.networks.get("bridge").disconnect(container)
        
        # 4. 执行离线测试
        results = await run_blind_tests(container, tasks)
        
        # 5. 检测网络调用
        blocked_calls = detect_network_calls(container)
        
    finally:
        # 6. 销毁容器
        container.remove(force=True)
```

### 5.2 回归测试并行方案

**决策：并行容器池**

```python
async def run_regression_parallel(approved_skills: list[str]) -> dict:
    """并行回归测试"""
    
    # 创建并行任务
    tasks = []
    for skill in approved_skills:
        task = asyncio.create_task(
            test_single_skill(skill),
            name=f"regress-{skill}"
        )
        tasks.append(task)
    
    # 并行执行，收集结果
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    # 汇总结果
    return {
        skill: result 
        for skill, result in zip(approved_skills, results)
    }

async def test_single_skill(skill_name: str) -> dict:
    """单个 skill 的回归测试（独立容器）"""
    
    # 创建独立容器（复用已安装依赖的镜像）
    container = create_regression_container()
    
    try:
        # 读取 skill 的 SKILL.md
        # 生成 3 个测试任务
        # 执行测试
        # 返回结果
        ...
    finally:
        container.remove(force=True)
```

### 5.3 验证触发时机

**决策：上传后自动触发**

| 方案 | 优点 | 缺点 |
|------|------|------|
| **自动触发** | 用户体验好，减少操作 | 可能浪费资源 |
| 手动触发 | 精确控制 | 操作繁琐 |

### 5.4 管理员角色

**决策：需要管理员角色**

- User 表新增 `is_admin` 字段
- 只有管理员可访问 `/api/admin/*` 端点
- 普通用户无法操作 Skill 管理
