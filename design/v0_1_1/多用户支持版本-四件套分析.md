# v0.1.1 å¤šç”¨æˆ·æ”¯æŒç‰ˆæœ¬ - å››ä»¶å¥—åˆ†æï¼ˆç®€åŒ–ç‰ˆï¼‰

> ç‰ˆæœ¬ï¼šv0.1.1  
> åŸºäºç‰ˆæœ¬ï¼šv0.1.0 MVP  
> è§„åˆ’æ—¥æœŸï¼š2026-02-11  
> **æ ¸å¿ƒåŸåˆ™ï¼šé¿å…é€ è½®å­ï¼Œåˆ©ç”¨LangGraph/DeepAgentså·²æœ‰èƒ½åŠ›ï¼Œæœ€å°å¯éªŒè¯å®ç°å¤šç”¨æˆ·éš”ç¦»**

---

## ä¸€ã€æ ¸å¿ƒå‘ç°ï¼šå·²æœ‰èƒ½åŠ›ç›˜ç‚¹

### 1. LangGraphå¤©ç„¶éš”ç¦»èƒ½åŠ›
- **thread_idæ˜¯ä¸»é”®**ï¼šä¸åŒthread_idçš„çŠ¶æ€å®Œå…¨éš”ç¦»
- **PostgresSaver**ï¼šå®˜æ–¹æ”¯æŒï¼Œä¸€è¡Œä»£ç ä»å†…å­˜åˆ‡æ¢åˆ°PostgreSQL
- **checkpointæœºåˆ¶**ï¼šè‡ªåŠ¨æŒä¹…åŒ–æ¶ˆæ¯å†å²ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†

### 2. DeepAgentsåŠ¨æ€backend
- MVPå·²å®ç°ï¼š`backend=lambda runtime: get_thread_backend(...)`
- åªéœ€åœ¨get_thread_backendä¸­æ ¹æ®user_idé€‰æ‹©å·¥ä½œç©ºé—´

### 3. FastAPIæ ‡å‡†è®¤è¯
- JWT Tokenæ˜¯è¡Œä¸šæ ‡å‡†
- python-jose + passlibæ˜¯æ ‡å‡†ç»„åˆ
- OAuth2PasswordBeareråŸç”Ÿæ”¯æŒ

---

## äºŒã€å››ä»¶å¥—åˆ†æ

### ç°è±¡(å®é™…)

**MVPç°çŠ¶ï¼š**
- âœ… Dockeræ²™ç®±éš”ç¦»
- âœ… SSEæµå¼å“åº”
- âœ… HITLä¸­æ–­æœºåˆ¶
- âš ï¸ thread_idæ ¼å¼ï¼š`user-{uuid}`ï¼ˆä¼ªå¤šç”¨æˆ·ï¼‰
- âš ï¸ MemorySaverï¼šé‡å¯æ•°æ®ä¸¢å¤±
- âš ï¸ æ— è®¤è¯ï¼šä»»ä½•äººå¯è®¿é—®ä»»æ„thread

**æ ¸å¿ƒé—®é¢˜ï¼š**
1. æ— æ³•åŒºåˆ†çœŸå®ç”¨æˆ·ï¼ˆéƒ½æ˜¯`user-`å‰ç¼€ï¼‰
2. æ— æ³•æŒä¹…åŒ–å¯¹è¯å†å²
3. æ— æƒé™æ§åˆ¶ï¼ˆè¶Šæƒè®¿é—®é£é™©ï¼‰

---

### æ„å›¾(æœŸæœ›)

**æœ€å°ç›®æ ‡ï¼šçœŸæ­£çš„å¤šç”¨æˆ·éš”ç¦»**

| éœ€æ±‚ | å®ç°æ–¹å¼ | æ˜¯å¦é€ è½®å­ |
|------|---------|-----------|
| ç”¨æˆ·è®¤è¯ | JWT Token (python-jose) | âŒ æ ‡å‡†æ–¹æ¡ˆ |
| å¯¹è¯æŒä¹…åŒ– | PostgresSaver (LangGraph) | âŒ å®˜æ–¹æ”¯æŒ |
| threadéš”ç¦» | `{user_id}-{uuid}`æ ¼å¼ | âŒ åˆ©ç”¨thread_idæœºåˆ¶ |
| æƒé™éªŒè¯ | thread_idå‰ç¼€æ£€æŸ¥ | âŒ ç®€å•é€»è¾‘ |
| å·¥ä½œç©ºé—´éš”ç¦» | `workspaces/{user_id}/{thread_id}` | âŒ ç›®å½•åˆ†å±‚ |

**ä¸åšï¼š**
- âŒ è§’è‰²æƒé™ç³»ç»Ÿï¼ˆRBACï¼‰
- âŒ OAuthç¬¬ä¸‰æ–¹ç™»å½•
- âŒ å¤æ‚çš„ç”¨æˆ·ç®¡ç†ï¼ˆåˆ é™¤/ä¿®æ”¹ç­‰ï¼‰
- âŒ å‰ç«¯ç•Œé¢

---

### æƒ…å¢ƒ(ç¯å¢ƒçº¦æŸ)

**æŠ€æœ¯æ ˆï¼š**
- Python 3.13 + FastAPI + LangGraph + deepagents
- PostgreSQL (ç”¨äºcheckpointæŒä¹…åŒ–)
- JWT (python-jose) + bcrypt (passlib)

**å…³é”®çº¦æŸï¼š**

1. **LangGraph PostgresSaverè¡¨ç»“æ„**ï¼š
   - checkpointè¡¨ç”±LangGraphè‡ªåŠ¨åˆ›å»º
   - åªéœ€åˆ›å»ºusersè¡¨

2. **thread_idæ ¼å¼å˜åŒ–**ï¼š
   - ä»ï¼š`user-{uuid}`
   - åˆ°ï¼š`{user_id}-{uuid}`ï¼ˆç¤ºä¾‹ï¼š`alice-550e8400-xxx`ï¼‰

3. **æƒé™éªŒè¯é€»è¾‘**ï¼š
   ```python
   # thread_idå¿…é¡»ä»¥user_idå¼€å¤´
   if not thread_id.startswith(f"{user_id}-"):
       raise HTTPException(403)
   ```

4. **å·¥ä½œç©ºé—´ç›®å½•**ï¼š
   ```
   workspaces/
   â”œâ”€â”€ alice/
   â”‚   â”œâ”€â”€ alice-550e8400-xxx/  # thread 1
   â”‚   â””â”€â”€ alice-6ba7b810-xxx/  # thread 2
   â””â”€â”€ bob/
       â””â”€â”€ bob-9bd0e020-xxx/    # bobçš„thread
   ```

---

### è¾¹ç•Œ(æ˜ç¡®ä¸åš)

#### âŒ v0.1.1ä¸åš
- å‰ç«¯ç•Œé¢ï¼ˆVue/Vuetifyï¼‰
- è§’è‰²æƒé™ç³»ç»Ÿï¼ˆç®¡ç†å‘˜/æ™®é€šç”¨æˆ·ï¼‰
- ç”¨æˆ·åˆ é™¤/ä¿®æ”¹åŠŸèƒ½
- é‚®ä»¶éªŒè¯/å¯†ç é‡ç½®
- ä¼šè¯åˆ—è¡¨APIï¼ˆè·å–ç”¨æˆ·çš„æ‰€æœ‰sessionsï¼‰
- Redisç¼“å­˜
- å®¹å™¨èµ„æºé…é¢
- ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿï¼ˆé™¤Langfuseå¤–ï¼‰

#### âœ… v0.1.1åªåš
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•ï¼ˆJWTï¼‰
- PostgresSaveræ›¿æ¢MemorySaver
- thread_idæ ¼å¼æ”¹ä¸º`{user_id}-{uuid}`
- thread_idå‰ç¼€æƒé™éªŒè¯
- ç”¨æˆ·å·¥ä½œç©ºé—´ç›®å½•éš”ç¦»

---

## ä¸‰ã€æœ€å°å®ç°æ–¹æ¡ˆ

### æ”¹åŠ¨æ¸…å•ï¼ˆæ ¸å¿ƒä»£ç <200è¡Œï¼‰

| æ–‡ä»¶ | æ”¹åŠ¨ | ä»£ç è¡Œæ•° |
|------|------|---------|
| `pyproject.toml` | æ·»åŠ ä¾èµ– | +6 |
| `src/config.py` | æ·»åŠ DATABASE_URL | +1 |
| `src/database.py` | æ•°æ®åº“è¿æ¥+Useræ¨¡å‹ | ~30 |
| `src/auth.py` | JWTè®¤è¯é€»è¾‘ | ~50 |
| `src/agent_manager.py` | PostgresSaver+thread_idæ ¼å¼ | ~10 |
| `src/docker_sandbox.py` | å·¥ä½œç©ºé—´è·¯å¾„ä¿®æ”¹ | ~5 |
| `api/auth.py` | æ³¨å†Œ/ç™»å½•API | ~40 |
| `api/server.py` | æ·»åŠ è®¤è¯ä¾èµ– | ~15 |
| `main.py` | åŒ…å«authè·¯ç”± | +2 |

**æ€»è®¡ï¼šæ–°å¢~159è¡Œ**

---

### 1. ä¾èµ–æ·»åŠ ï¼ˆpyproject.tomlï¼‰

```toml
[project]
dependencies = [
    # ç°æœ‰ä¾èµ–...
    "langgraph-checkpoint-postgres>=0.1.0",
    "sqlalchemy>=2.0.0",
    "psycopg2-binary>=2.9.0",
    "python-jose[cryptography]>=3.3.0",
    "passlib[bcrypt]>=1.7.4",
    "python-multipart>=0.0.6",
]
```

---

### 2. æ•°æ®åº“é…ç½®ï¼ˆsrc/config.pyï¼‰

```python
class Settings(BaseSettings):
    """Application settings loaded from environment variables."""
    model_config = SettingsConfigDict(env_file=get_project_root() / ".env", env_file_encoding="utf-8")

    # ç°æœ‰é…ç½®...
    ZHIPUAI_API_KEY: str
    ZHIPUAI_API_BASE: str
    # ... å…¶ä»–ç°æœ‰é…ç½®

    # æ–°å¢ï¼šæ•°æ®åº“é…ç½®
    DATABASE_URL: str = "postgresql://agent_user:agent_password@localhost/agent_db"
    
    # æ–°å¢ï¼šJWTé…ç½®
    SECRET_KEY: str = "your-secret-key-change-in-production"
    ACCESS_TOKEN_EXPIRE_HOURS: int = 24

# å…¨å±€settingså®ä¾‹ï¼ˆå·²å­˜åœ¨ï¼‰
settings = Settings()

# ä½¿ç”¨æ–¹å¼ï¼šsettings.DATABASE_URL, settings.SECRET_KEY
```

---

### 3. æ•°æ®åº“è¿æ¥ï¼ˆsrc/database.pyï¼‰

```python
from sqlalchemy import create_engine, Column, String, DateTime, func
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from src.config import settings  # ä½¿ç”¨settingså¯¹è±¡

engine = create_engine(settings.DATABASE_URL)  # ä½¿ç”¨settings.DATABASE_URL
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

class User(Base):
    __tablename__ = "users"
    user_id = Column(String(50), primary_key=True)
    username = Column(String(50), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    created_at = Column(DateTime, server_default=func.now())

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

---

### 4. JWTè®¤è¯ï¼ˆsrc/auth.pyï¼‰

```python
from datetime import datetime, timedelta
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt
from passlib.context import CryptContext
from src.config import settings  # ä½¿ç”¨settingså¯¹è±¡

# ä»settingsè·å–é…ç½®
SECRET_KEY = settings.SECRET_KEY
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_HOURS = settings.ACCESS_TOKEN_EXPIRE_HOURS

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/auth/login")

def verify_password(plain, hashed):
    return pwd_context.verify(plain, hashed)

def get_password_hash(password):
    return pwd_context.hash(password)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(hours=ACCESS_TOKEN_EXPIRE_HOURS)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

async def get_current_user(token: str = Depends(oauth2_scheme)):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Could not validate credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        user_id: str = payload.get("sub")
        if user_id is None:
            raise credentials_exception
        return user_id
    except JWTError:
        raise credentials_exception

def verify_thread_permission(user_id: str, thread_id: str):
    """éªŒè¯thread_idæ˜¯å¦å±äºuser_id"""
    if not thread_id.startswith(f"{user_id}-"):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail=f"Access denied to thread {thread_id}"
        )
```

---

### 5. AgentManagerä¿®æ”¹ï¼ˆsrc/agent_manager.pyï¼‰

```python
from langgraph.checkpoint.postgres import PostgresSaver  # ä¿®æ”¹1ï¼šå¯¼å…¥PostgresSaver
from src.config import settings  # ä¿®æ”¹2ï¼šä½¿ç”¨settingså¯¹è±¡

class AgentManager:
    def __init__(self):
        # ä¿®æ”¹3ï¼šæ›¿æ¢MemorySaverï¼Œä½¿ç”¨settings.DATABASE_URL
        self.checkpointer = PostgresSaver.from_conn_string(settings.DATABASE_URL)
        self.checkpointer.setup()  # è‡ªåŠ¨åˆ›å»ºcheckpointè¡¨
        
        self.compiled_agent = create_deep_agent(
            model=llm,
            backend=lambda runtime: get_thread_backend(self._get_thread_id(runtime) or "default"),
            checkpointer=self.checkpointer,
            interrupt_on={"execute": True, "write_file": True},
            system_prompt="ç”¨æˆ·çš„å·¥ä½œç›®å½•åœ¨/workspaceä¸­ï¼Œè‹¥æ— æ˜ç¡®è¦æ±‚ï¼Œè¯·åœ¨/workspaceç›®å½•ã€åŠå­ç›®å½•ã€‘ä¸‹æ‰§è¡Œæ“ä½œ"
        )

    async def create_session(self, user_id: str) -> str:  # ä¿®æ”¹4ï¼šæ¥æ”¶user_idå‚æ•°
        # ä¿®æ”¹5ï¼šthread_idæ ¼å¼æ”¹ä¸º {user_id}-{uuid}
        thread_id = f"{user_id}-{uuid.uuid4()}"
        get_thread_backend(thread_id)
        return thread_id
```

---

### 6. DockerSandboxä¿®æ”¹ï¼ˆsrc/docker_sandbox.pyï¼‰

```python
def get_thread_backend(thread_id: str) -> 'DockerSandboxBackend':
    if thread_id not in _thread_backends:
        # ä¿®æ”¹ï¼šå·¥ä½œç©ºé—´è·¯å¾„æ”¹ä¸º workspaces/{user_id}/{thread_id}
        user_id = thread_id.split('-')[0]
        workspace_dir = os.path.join(WORKSPACE_ROOT, user_id, thread_id)
        os.makedirs(workspace_dir, exist_ok=True)
        _thread_backends[thread_id] = DockerSandboxBackend(thread_id, workspace_dir)
    return _thread_backends[thread_id]
```

---

### 7. è®¤è¯APIï¼ˆapi/auth.pyï¼‰

```python
from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel
from sqlalchemy.orm import Session
from src.auth import verify_password, get_password_hash, create_access_token
from src.database import get_db, User

router = APIRouter()

class UserRegister(BaseModel):
    username: str
    password: str

class UserLogin(BaseModel):
    username: str
    password: str

class Token(BaseModel):
    access_token: str
    token_type: str

@router.post("/register")
async def register(user: UserRegister, db: Session = Depends(get_db)):
    if db.query(User).filter(User.username == user.username).first():
        raise HTTPException(status_code=400, detail="Username already registered")
    
    db_user = User(
        user_id=user.username,  # ç®€å•æ–¹æ¡ˆï¼šuser_id = username
        username=user.username,
        password_hash=get_password_hash(user.password)
    )
    db.add(db_user)
    db.commit()
    
    return {"message": "User registered", "user_id": db_user.user_id}

@router.post("/login", response_model=Token)
async def login(user: UserLogin, db: Session = Depends(get_db)):
    db_user = db.query(User).filter(User.username == user.username).first()
    if not db_user or not verify_password(user.password, db_user.password_hash):
        raise HTTPException(status_code=401, detail="Incorrect username or password")
    
    access_token = create_access_token(data={"sub": db_user.user_id})
    return {"access_token": access_token, "token_type": "bearer"}
```

---

### 8. APIè·¯ç”±ä¿®æ”¹ï¼ˆapi/server.pyï¼‰

```python
from fastapi import APIRouter, HTTPException, Depends
from fastapi.responses import StreamingResponse
from src.agent_manager import AgentManager
from src.auth import get_current_user, verify_thread_permission  # å¯¼å…¥è®¤è¯
from api.models import ChatRequest, CreateSessionResponse, ResumeRequest, ResumeResponse

router = APIRouter()
agent_manager = AgentManager()

@router.post("/sessions", response_model=CreateSessionResponse)
async def create_session(user_id: str = Depends(get_current_user)):  # æ·»åŠ è®¤è¯
    thread_id = await agent_manager.create_session(user_id)  # ä¼ å…¥user_id
    return CreateSessionResponse(thread_id=thread_id)

@router.post("/chat/{thread_id}")
async def chat(
    thread_id: str, 
    request: ChatRequest, 
    user_id: str = Depends(get_current_user)  # æ·»åŠ è®¤è¯
):
    verify_thread_permission(user_id, thread_id)  # éªŒè¯æƒé™
    
    async def event_generator():
        async for chunk in agent_manager.stream_chat(thread_id, request.message):
            yield chunk
    
    return StreamingResponse(event_generator(), media_type="text/event-stream")

@router.post("/resume/{thread_id}", response_model=ResumeResponse)
async def resume_interrupt(
    thread_id: str, 
    request: ResumeRequest, 
    user_id: str = Depends(get_current_user)  # æ·»åŠ è®¤è¯
):
    verify_thread_permission(user_id, thread_id)  # éªŒè¯æƒé™
    
    try:
        result = await agent_manager.resume_interrupt(thread_id, request.action)
        return ResumeResponse(success=result["success"], message=result["message"])
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Failed to resume: {str(e)}")
```

---

### 9. ä¸»åº”ç”¨ä¿®æ”¹ï¼ˆmain.pyï¼‰

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from api.server import router as api_router
from api.auth import router as auth_router  # å¯¼å…¥authè·¯ç”±

app = FastAPI(
    title="Multi-tenant AI Agent Platform",
    description="Backend service for AI coding agents",
    version="0.1.1"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.include_router(auth_router, prefix="/api/auth")  # æ·»åŠ authè·¯ç”±
app.include_router(api_router, prefix="/api")

@app.get("/")
async def root():
    return {
        "message": "Multi-tenant AI Agent Platform v0.1.1",
        "version": "0.1.1",
        "endpoints": {
            "register": "POST /api/auth/register",
            "login": "POST /api/auth/login",
            "create_session": "POST /api/sessions",
            "chat": "POST /api/chat/{thread_id}",
            "resume": "POST /api/resume/{thread_id}"
        }
    }
```

---

## å››ã€PostgreSQLé…ç½®

### æ–¹æ¡ˆä¸€ï¼šæœ¬åœ°å®‰è£…PostgreSQL

**Windowsï¼ˆä½¿ç”¨å®‰è£…ç¨‹åºï¼‰ï¼š**
1. ä¸‹è½½å¹¶å®‰è£… PostgreSQL: https://www.postgresql.org/download/windows/
2. åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·ï¼š
   ```sql
   CREATE USER agent_user WITH PASSWORD 'agent_password';
   CREATE DATABASE agent_db OWNER agent_user;
   ```

**macOSï¼ˆä½¿ç”¨Homebrewï¼‰ï¼š**
```bash
brew install postgresql@16
brew services start postgresql@16

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
psql postgres -c "CREATE USER agent_user WITH PASSWORD 'agent_password';"
psql postgres -c "CREATE DATABASE agent_db OWNER agent_user;"
```

**Linuxï¼ˆUbuntu/Debianï¼‰ï¼š**
```bash
sudo apt update
sudo apt install postgresql-16
sudo systemctl start postgresql

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
sudo -u postgres psql -c "CREATE USER agent_user WITH PASSWORD 'agent_password';"
sudo -u postgres psql -c "CREATE DATABASE agent_db OWNER agent_user;"
```

### æ–¹æ¡ˆäºŒï¼šDockerè¿è¡ŒPostgreSQLï¼ˆå¯é€‰ï¼‰

```bash
# ä»…å¯åŠ¨PostgreSQLå®¹å™¨
docker run -d \
  --name agent-postgres \
  -e POSTGRES_USER=agent_user \
  -e POSTGRES_PASSWORD=agent_password \
  -e POSTGRES_DB=agent_db \
  -p 5432:5432 \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:16-alpine
```

### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.envï¼‰

```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://agent_user:agent_password@localhost/agent_db

# JWTé…ç½®
SECRET_KEY=your-secret-key-change-in-production
ACCESS_TOKEN_EXPIRE_HOURS=24
```

---

## äº”ã€éªŒè¯æµç¨‹

### 1. å¯åŠ¨æœåŠ¡
```bash
# ç¡®ä¿PostgreSQLå·²å¯åŠ¨ï¼ˆæœ¬åœ°æˆ–Dockerï¼‰

# å¯åŠ¨BackendæœåŠ¡
uvicorn main:app --reload --host 0.0.0.0 --port 8002
```

### 2. ç”¨æˆ·æ³¨å†Œ
```bash
curl -X POST http://localhost:8002/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "alice", "password": "password123"}'

# å“åº”
{"message": "User registered", "user_id": "alice"}
```

### 3. ç”¨æˆ·ç™»å½•
```bash
curl -X POST http://localhost:8002/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "alice", "password": "password123"}'

# å“åº”
{"access_token": "eyJhbGc...", "token_type": "bearer"}
```

### 4. åˆ›å»ºsessionï¼ˆéœ€è¦Tokenï¼‰
```bash
curl -X POST http://localhost:8002/api/sessions \
  -H "Authorization: Bearer eyJhbGc..."

# å“åº”
{"thread_id": "alice-550e8400-e29b-41d4-a716-446655440000"}
```

### 5. å‘é€æ¶ˆæ¯ï¼ˆSSEæµï¼‰
```bash
curl -X POST http://localhost:8002/api/chat/alice-550e8400-xxx \
  -H "Authorization: Bearer eyJhbGc..." \
  -H "Content-Type: application/json" \
  -d '{"message": "åˆ›å»ºä¸€ä¸ªhello.pyæ–‡ä»¶"}'
```

### 6. è¶Šæƒè®¿é—®æµ‹è¯•ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
```bash
# ç”¨bobçš„tokenè®¿é—®aliceçš„thread
curl -X POST http://localhost:8002/api/chat/alice-550e8400-xxx \
  -H "Authorization: Bearer bob_token..." \
  -H "Content-Type: application/json" \
  -d '{"message": "Hello"}'

# å“åº”ï¼š403 Forbidden
{"detail": "Access denied to thread alice-550e8400-xxx"}
```

### 7. é‡å¯éªŒè¯æŒä¹…åŒ–
```bash
# é‡å¯æœåŠ¡
pkill uvicorn
uvicorn main:app --reload

# ä½¿ç”¨ç›¸åŒçš„tokenå’Œthread_idè®¿é—®
curl -X POST http://localhost:8002/api/chat/alice-550e8400-xxx \
  -H "Authorization: Bearer eyJhbGc..." \
  -d '{"message": "æˆ‘ä»¬åˆšæ‰è¯´åˆ°å“ªäº†ï¼Ÿ"}'

# åº”è¯¥èƒ½æ¢å¤å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆå› ä¸ºä½¿ç”¨äº†PostgresSaverï¼‰
```

---

## å…­ã€éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶ âœ…
- [ ] ç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼Œuser_id = username
- [ ] ç”¨æˆ·ç™»å½•è·å–JWT Token
- [ ] ä½¿ç”¨Tokenåˆ›å»ºsessionï¼Œthread_idæ ¼å¼ä¸º`{username}-{uuid}`
- [ ] ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„threadï¼ˆå‰ç¼€éªŒè¯ï¼‰
- [ ] æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·çš„threadï¼ˆè¿”å›403ï¼‰
- [ ] æœåŠ¡é‡å¯åå¯¹è¯å†å²ä¸ä¸¢å¤±
- [ ] å·¥ä½œç©ºé—´ç›®å½•ç»“æ„ï¼š`workspaces/{username}/{thread_id}/`

### å®‰å…¨éªŒæ”¶ ğŸ”’
- [ ] å¯†ç ä½¿ç”¨bcryptåŠ å¯†
- [ ] Token 24å°æ—¶è¿‡æœŸ
- [ ] æ‰€æœ‰æ•æ„Ÿç«¯ç‚¹éœ€è¦è®¤è¯
- [ ] è¶Šæƒè®¿é—®è¿”å›403

---

## ä¸ƒã€æ–¹æ¡ˆä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **ä¸é€ è½®å­** | å…¨éƒ¨ä½¿ç”¨å®˜æ–¹/æ ‡å‡†æ–¹æ¡ˆ |
| **ä»£ç é‡å°‘** | æ ¸å¿ƒä»£ç <200è¡Œ |
| **æ˜“äºéªŒè¯** | æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹å¯æµ‹ |
| **å‘åå…¼å®¹** | LangGraph/DockerSandboxé€»è¾‘ä¸å˜ |
| **å¯æ‰©å±•** | ä¸ºåç»­ç‰ˆæœ¬æ‰“ä¸‹è‰¯å¥½åŸºç¡€ |

---

## å…«ã€é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|----------|
| PostgresSaverä¾èµ– | ä½ | LangGraphå®˜æ–¹æ”¯æŒï¼Œæ–‡æ¡£å®Œå–„ |
| JWTå¯†é’¥æ³„éœ² | ä¸­ | ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œç”Ÿäº§ç¯å¢ƒæ›´æ¢å¼ºå¯†é’¥ |
| thread_idå†²çª | ä½ | UUIDä¿è¯å”¯ä¸€æ€§ |
| æƒé™éªŒè¯é—æ¼ | ä¸­ | ä»£ç å®¡æŸ¥ï¼Œå•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰ç«¯ç‚¹ |

---

## ä¹ã€åç»­ç‰ˆæœ¬è§„åˆ’

### v0.2.0ï¼ˆå‰ç«¯ï¼‰
- Vue + TypeScript + Vuetify UI
- å¯¹è¯ç•Œé¢
- ç”¨æˆ·ç®¡ç†ç•Œé¢

### v0.3.0ï¼ˆå¢å¼ºï¼‰
- ä¼šè¯åˆ—è¡¨API
- ç”¨æˆ·é…ç½®
- ä¼šè¯åˆ é™¤

### v0.4.0ï¼ˆä¼˜åŒ–ï¼‰
- Redisç¼“å­˜
- å®¹å™¨æ± ç®¡ç†
- ç›‘æ§å’Œæ—¥å¿—

---

## åã€å‚è€ƒèµ„æ–™

- [LangGraph PostgresSaver](https://langchain-ai.github.io/langgraph/how_to/persistence_postgres/)
- [FastAPI Security - OAuth2](https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/)
- [python-joseæ–‡æ¡£](https://github.com/mpdavis/python-jose)
- [passlibæ–‡æ¡£](https://passlib.readthedocs.io/)
