# 测试用例

## 1. 上传 API 测试

### 1.1 测试正常文件上传

```python
def test_upload_simple_normal_file():
    """测试正常文件 (≤50MB) 上传"""
    # 1. 登录获取 token
    # 2. 上传文件
    # 3. 验证返回 path 格式正确
    # 4. 验证文件实际存在
```

### 1.2 测试大文件拒绝

```python
def test_upload_large_file_rejected():
    """测试大文件 (>50MB) 被拒绝"""
    # 1. 登录获取 token
    # 2. 上传 51MB 文件
    # 3. 验证返回 413 错误
    # 4. 验证错误信息提示使用 WebDAV
```

### 1.3 测试文件数量限制

```python
def test_upload_too_many_files():
    """测试超过 5 个文件被拒绝"""
    # 1. 登录获取 token
    # 2. 尝试发送 6 个文件路径
    # 3. 验证返回 400 错误
```

### 1.4 测试文件名处理

```python
def test_upload_filename_with_spaces():
    """测试带空格的文件名"""
    # 1. 上传 "my file.pdf"
    # 2. 验证保存成功
    # 3. 验证返回的 filename 是原始名称
```

### 1.5 测试无扩展名文件

```python
def test_upload_no_extension():
    """测试无扩展名文件"""
    # 1. 上传无扩展名文件
    # 2. 验证保存成功
```

---

## 2. Chat 文件注入测试（SystemMessage 方案）

### 2.1 测试带文件的消息

```python
def test_chat_with_files():
    """测试带文件的消息注入（SystemMessage 方案）"""
    # 1. 创建 session
    # 2. 上传文件获取 path
    # 3. 发送带 files 的消息
    # 4. 验证 agent 收到 SystemMessage + HumanMessage
```

### 2.2 测试多个文件

```python
def test_chat_with_multiple_files():
    """测试多个文件的消息"""
    # 1. 上传 3 个文件
    # 2. 发送消息携带 3 个文件路径
    # 3. 验证 SystemMessage 包含所有文件路径
```

### 2.3 测试空消息仅文件

```python
def test_chat_with_only_files():
    """测试仅发送文件无消息"""
    # 1. 上传文件
    # 2. 发送空消息 + files
    # 3. 验证 SystemMessage 正常，HumanMessage 为空
```

### 2.4 测试无文件消息

```python
def test_chat_without_files():
    """测试不带文件的消息（兼容性）"""
    # 1. 发送普通消息
    # 2. 验证仅 HumanMessage，无 SystemMessage
```

### 2.5 测试历史记录过滤（关键）

```python
def test_history_filtering():
    """测试历史记录中过滤掉文件 SystemMessage"""
    # 1. 创建 session
    # 2. 上传文件
    # 3. 发送带 files 的消息
    # 4. 调用 GET /api/history/{thread_id}
    # 5. 验证返回的 messages 中不包含文件 SystemMessage
    # 6. 验证用户消息内容是原始的，没有被注入文件信息
```

---

## 3. 集成测试脚本

**文件**: `tests/test_v0_1_7_file_upload.py`

```python
"""v0.1.7 对话文件上传测试"""
import requests
import io

BASE_URL = "http://localhost:8002"

def test_01_register_and_login():
    """[1/6] 注册并登录"""
    # ...
    
def test_02_create_session():
    """[2/6] 创建会话"""
    # ...

def test_03_upload_simple():
    """[3/6] 测试简单上传"""
    # 创建测试文件内容
    content = b"Hello, this is a test file content!"
    
    files = {"file": ("test.txt", io.BytesIO(content), "text/plain")}
    headers = {"Authorization": f"Bearer {token}"}
    
    resp = requests.post(f"{BASE_URL}/api/files/upload-simple", 
                         files=files, headers=headers)
    
    assert resp.status_code == 200
    data = resp.json()
    assert data["success"] is True
    assert "/workspace/uploads/" in data["path"]
    assert data["filename"] == "test.txt"
    
    print(f"  ✅ 上传成功: {data['path']}")
    return data["path"]

def test_04_upload_large_file_rejected():
    """[4/6] 测试大文件被拒绝"""
    # 创建 51MB 文件
    content = b"x" * (51 * 1024 * 1024)
    
    files = {"file": ("large.bin", io.BytesIO(content), "application/octet-stream")}
    headers = {"Authorization": f"Bearer {token}"}
    
    resp = requests.post(f"{BASE_URL}/api/files/upload-simple",
                         files=files, headers=headers)
    
    assert resp.status_code == 413
    assert "WebDAV" in resp.json().get("detail", "")
    print(f"  ✅ 大文件正确拒绝: {resp.json()}")

def test_05_chat_with_file():
    """[5/6] 测试带文件的对话"""
    # 上传文件
    file_path = test_03_upload_simple()
    
    # 发送带文件的消息
    headers = {"Authorization": f"Bearer {token}"}
    data = {
        "message": "这个文件里有什么？",
        "files": [file_path]
    }
    
    resp = requests.post(f"{BASE_URL}/api/chat/{thread_id}",
                         json=data, headers=headers, stream=True)
    
    assert resp.status_code == 200
    # 验证 SSE 响应
    for line in resp.iter_lines():
        if line:
            print(f"  📨 {line.decode()}")
    print(f"  ✅ 带文件对话成功")

def test_06_chat_without_file():
    """[6/6] 测试不带文件的对话（兼容性）"""
    headers = {"Authorization": f"Bearer {token}"}
    data = {"message": "你好"}
    
    resp = requests.post(f"{BASE_URL}/api/chat/{thread_id}",
                         json=data, headers=headers, stream=True)
    
    assert resp.status_code == 200
    print(f"  ✅ 不带文件对话成功")

if __name__ == "__main__":
    print("=" * 50)
    print("v0.1.7 对话文件上传测试")
    print("=" * 50)
    
    token = test_01_register_and_login()
    thread_id = test_02_create_session()
    test_03_upload_simple()
    test_04_upload_large_file_rejected()
    test_05_chat_with_file()
    test_06_chat_without_file()
    
    print("\n" + "=" * 50)
    print("✅ 所有测试通过")
    print("=" * 50)
```

---

## 4. 手动验证清单

### 4.1 API 验证

| # | 验证项 | 方法 |
|---|--------|------|
| 1 | 上传返回正确路径 | Postman 测试 |
| 2 | 大文件返回 413 | 上传 51MB 文件 |
| 3 | 文件保存到正确目录 | 检查 `workspaces/{user}/uploads/` |
| 4 | Chat 正常响应 | 发送带 files 的消息 |
| 5 | **历史记录过滤** | 验证 SystemMessage 不出现在历史中 |
| 6 | **文件数量限制** | 发送 6 个文件路径，验证 400 错误 |

### 4.2 兼容性验证

| # | 验证项 | 方法 |
|---|--------|------|
| 1 | 旧客户端（不传 files）正常工作 | 只传 message |
| 2 | files 为空数组正常工作 | `files: []` |
| 3 | WebDAV 仍正常工作 | 上传超大文件 |

### 4.3 边界测试

| # | 验证项 | 方法 |
|---|--------|------|
| 1 | 恰好 50MB 文件 | 上传 52428800 字节 |
| 2 | 恰好 5 个文件 | 上传 5 个文件 |
| 3 | 文件名含中文 | 上传 "测试文件.txt" |
| 4 | 文件名含特殊字符 | 上传 "file (1).pdf" |
| 5 | 空文件 | 上传 0 字节文件 |

---

## 5. 预期结果

### 5.1 上传成功响应

```json
{
  "success": true,
  "path": "/workspace/uploads/20260215_143022_a1b2c3.pdf",
  "filename": "report.pdf",
  "size": 1234567
}
```

### 5.2 大文件拒绝响应

```json
{
  "detail": "文件超过 50MB，请使用 WebDAV 上传到工作目录"
}
```

### 5.3 文件数量超限响应

```json
{
  "detail": "单次最多上传 5 个文件，请分批上传或使用 WebDAV"
}
```

### 5.4 Agent 收到的消息结构（SystemMessage 方案）

```python
# 传给 LLM 的 messages 列表
[
    SystemMessage(content="当前对话中用户已上传的文件：\n- /workspace/uploads/20260215_143022_a1b2c3.pdf"),
    HumanMessage(content="帮我分析这个文件")  # 用户原始消息，干净
]
```

### 5.5 历史接口返回（过滤后）

```json
{
  "thread_id": "user123-thread-abc",
  "messages": [
    {"role": "user", "content": "帮我分析这个文件"},
    {"role": "assistant", "content": "好的，我来读取这个文件..."}
  ]
}
```

> 注意：历史记录中不包含文件 SystemMessage，用户看到的是干净的消息
