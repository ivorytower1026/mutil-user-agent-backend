# v0.1.6 用户级工作目录

> 将 Agent 工作目录从 thread 级别改为 user 级别，实现用户与 Agent 文件完全同步

---

## 一、现象（实际）

### 1.1 当前目录结构

```
workspaces/
├── user_001/
│   ├── user_001-thread-abc/    <- Agent session A 的独立目录
│   │   ├── project/
│   │   └── data.txt
│   ├── user_001-thread-def/    <- Agent session B 的独立目录
│   │   └── other_file.txt
│   └── shared/                  <- WebDAV 上传目录
│       └── upload.txt
└── user_002/
    └── ...
```

### 1.2 现有问题

| # | 问题 | 影响 |
|---|------|------|
| 1 | **目录不同步** | WebDAV 上传到 `user_001/`，Agent 在 `user_001/thread-abc/` 看不到 |
| 2 | **需要中转目录** | 必须通过 `/user_shared` 中转，操作繁琐 |
| 3 | **文件分散** | 同一用户的文件散落在多个 thread 目录，难以管理 |
| 4 | **体验割裂** | 用户以为操作的是同一个目录，实际是完全隔离的多个目录 |

### 1.3 相关代码位置

| 文件 | 行号 | 当前实现 |
|------|------|----------|
| `src/docker_sandbox.py` | 39-43 | `workspace_dir = .../user_id/thread_id` |
| `src/docker_sandbox.py` | 178-183 | 创建 `/user_shared` 挂载 |
| `src/webdav.py` | 38 | `base = root / user_id` (已是用户级) |

---

## 二、意图（期望）

### 2.1 目标目录结构

```
workspaces/
├── user_001/                    <- 用户级工作目录
│   ├── project/                 <- Agent 和 WebDAV 共享
│   ├── data.txt
│   └── upload.txt
└── user_002/
    └── ...
```

### 2.2 期望效果

| # | 期望 | 实现方式 |
|---|------|----------|
| 1 | **WebDAV 上传的文件 Agent 立即可见** | 两者都操作 `workspaces/{user_id}/` |
| 2 | **同一用户的所有 session 共享文件** | 所有 thread 容器挂载同一目录 |
| 3 | **移除 `/user_shared` 中转** | 不再需要，直接在 `/workspace` 操作 |
| 4 | **API 完全兼容** | `destroy_thread_backend` 仍销毁单个容器 |
| 5 | **容器环境隔离** | 每个 thread 仍独立容器，pip 安装互不影响 |

### 2.3 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                    目标架构 (方案C)                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  宿主机文件系统                                                      │
│  workspaces/user_001/                                               │
│  ├── project/                                                       │
│  └── data.txt                                                       │
│                                                                     │
│         ┌─────────────────┐    ┌─────────────────┐                 │
│         │  Container A    │    │  Container B    │                 │
│         │  (thread-abc)   │    │  (thread-def)   │                 │
│         │                 │    │                 │                 │
│         │  /workspace ────┼────┼───► workspaces/user_001/          │
│         │  /shared ───────┼────┼───► shared/ (ro)                  │
│         │  /skills ───────┼────┼───► skills/ (ro)                  │
│         └─────────────────┘    └─────────────────┘                 │
│                                                                     │
│  WebDAV 操作 ────────────────────► workspaces/user_001/            │
│                                                                     │
│  特点：                                                              │
│  - WebDAV / Agent / 多个 Thread 操作同一目录                         │
│  - 容器环境隔离 (pip安装互不影响)                                    │
│  - 文件完全同步                                                      │
│  - API 兼容                                                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、情境（环境约束）

### 3.1 技术栈约束

| 约束 | 说明 |
|------|------|
| Python 3.13 | 使用现代 Python 语法 |
| Docker Desktop (Windows) | 容器挂载需要路径转换 |
| FastAPI | API 框架不变 |
| PostgreSQL | 状态持久化不变 |
| LangGraph 1.0+ | Agent 框架不变 |

### 3.2 现有架构约束

| 约束 | 影响 |
|------|------|
| **Thread ID 格式** `{user_id}-{uuid}` | 可以从 thread_id 提取 user_id |
| **API 已上线** | 不能破坏现有 API 语义 |
| **JWT 认证** | user_id 从 token 获取，不变 |
| **WebDAV 已实现** | `src/webdav.py` 已经是用户级目录，无需修改 |

### 3.3 兼容性要求

| 组件 | 要求 |
|------|------|
| `api/server.py` | 无需修改 |
| `src/agent_manager.py` | 无需修改 |
| `src/webdav.py` | 无需修改 (已对齐) |
| `src/docker_sandbox.py` | **需要修改** |
| 前端 | 无需修改 |

---

## 四、边界（明确不做）

### 4.1 本次迭代不做

| # | 不做 | 原因 |
|---|------|------|
| 1 | **不做用户级容器合并** | 会导致环境污染、API 破坏性变更 |
| 2 | **不做文件锁机制** | 增加复杂度，并发场景少见 |
| 3 | **不做历史文件迁移** | 旧目录结构文件由用户自行处理 |
| 4 | **不做冲突检测** | 文件覆盖由用户自行控制 |
| 5 | **不改 WebDAV 代码** | 已是用户级目录，无需改动 |

### 4.2 范围外场景

| 场景 | 说明 |
|------|------|
| 同一用户两个 session 同时写同一文件 | 可能冲突，用户自行避免 |
| 迁移旧 thread 目录数据 | 不处理，新 session 从空目录开始 |
| 跨用户文件共享 | 仍通过 `/shared` 全局共享目录 |

---

## 五、方案选择

### 5.1 方案对比

| 方案 | 工作目录 | 容器粒度 | 文件共享 | 环境隔离 | API兼容 | 推荐 |
|------|----------|----------|----------|----------|---------|------|
| A. 用户级容器 | `{user_id}/` | user | ✅ | ❌ 污染 | ❌ 破坏 | |
| B. 保持现状 | `{user_id}/{thread_id}/` | thread | ❌ | ✅ | ✅ | |
| **C. 混合方案** | `{user_id}/` | thread | ✅ | ✅ | ✅ | ✓ |

### 5.2 选择方案C

**核心理由**：
1. ✅ 实现用户与 Agent 文件同步
2. ✅ 保持容器环境隔离
3. ✅ API 完全兼容
4. ✅ 代码改动量最小（仅 `docker_sandbox.py`）

---

## 六、风险评估

### 6.1 文件操作冲突 (中风险)

**场景**：同一用户的两个 thread 同时写入同一文件

**缓解**：
- 用户一般不会同时使用多个 session
- Agent 系统提示引导用户注意

### 6.2 容器销毁后文件保留 (预期行为)

**场景**：销毁 thread A 容器后，文件仍在

**说明**：这是预期行为，文件属于用户而非 thread

---

## 七、文件清单

| 文件 | 说明 |
|------|------|
| [README.md](./README.md) | 本文档 (四件套分析) |
| [实现计划.md](./实现计划.md) | 详细代码修改 |
| [测试用例.md](./测试用例.md) | 测试修改与验证 |

---

## 八、实施顺序

1. 修改 `src/docker_sandbox.py` (2处代码改动)
2. 更新 `tests/test_container_persistence.py` (2个测试改名)
3. 运行测试验证
4. 可选：标记 `src/config.py` 中 `USER_SHARED` 为废弃
