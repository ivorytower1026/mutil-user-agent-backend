# 测试用例

> 本文档专注测试修改细节，背景分析见 [README.md](./README.md)

---

## 一、修改汇总

| 测试文件 | 修改内容 |
|----------|----------|
| `tests/test_container_persistence.py` | 2个测试改名 + 路径更新 |
| `tests/test_v0_1_1.py` | 无需修改 |
| `tests/test_v0_1_5_webdav.py` | 无需修改 |

---

## 二、需要修改的测试

### 2.1 `test_user_shared_directory` → `test_workspace_shared`

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 测试名称 | `test_user_shared_directory` | `test_workspace_shared` |
| 测试路径 | `/user_shared/test.txt` | `/workspace/test.txt` |
| 测试目的 | 验证 `/user_shared` 共享 | 验证 `/workspace` 共享 |

### 2.2 `test_user_shared_isolation` → `test_workspace_isolation`

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 测试名称 | `test_user_shared_isolation` | `test_workspace_isolation` |
| 测试路径 | `/user_shared/a.txt` | `/workspace/a.txt` |
| 测试目的 | 验证 `/user_shared` 隔离 | 验证 `/workspace` 隔离 |

---

## 三、无需修改的测试

| 测试 | 原因 |
|------|------|
| `test_container_persistence` | 容器内状态持久化，路径 `/workspace` 不变 |
| `test_container_reuse` | 容器复用逻辑不变 |
| `test_destroy_session` | 销毁逻辑不变 |
| `test_destroy_idempotent` | 幂等销毁不变 |
| `test_file_persistence` | 文件持久化路径 `/workspace` 不变 |

---

## 四、验证清单

### 4.1 自动化测试

```bash
uv run python tests/test_container_persistence.py
```

预期输出：
```
[PASS] test_container_persistence
[PASS] test_container_reuse
[PASS] test_destroy_session
[PASS] test_destroy_idempotent
[PASS] test_file_persistence
[PASS] test_workspace_shared
[PASS] test_workspace_isolation
All tests passed!
```

### 4.2 手动验证

| # | 验证项 | 操作 | 预期 |
|---|--------|------|------|
| 1 | 同用户 thread 共享 | thread A 写入文件，thread B 读取 | 能读取 |
| 2 | 不同用户隔离 | user A 写入文件，user B 读取 | 无法读取 |
| 3 | WebDAV 同步 | WebDAV 上传文件，Agent 读取 | 能读取 |
| 4 | 容器销毁后保留 | 销毁容器，检查文件 | 文件保留 |

### 4.3 集成测试

```bash
run_tests.bat
```

---

## 五、回归测试

确保以下功能正常：

| 功能 | 验证方式 |
|------|----------|
| 创建 session | `POST /api/sessions` |
| Agent 对话 | `POST /api/chat/{thread_id}` |
| WebDAV 操作 | `PROPFIND/GET/PUT /dav/` |
| 容器销毁 | `DELETE /api/sessions/{thread_id}` |
