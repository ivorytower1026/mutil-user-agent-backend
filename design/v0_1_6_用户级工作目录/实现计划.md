# 实现计划

> 本文档专注代码修改细节，背景分析见 [README.md](./README.md)

---

## 一、修改汇总

| 文件 | 修改量 | 是否必须 |
|------|--------|----------|
| `src/docker_sandbox.py` | 2处 (~15行) | ✅ 必须 |
| `tests/test_container_persistence.py` | 2个测试改名 | ✅ 必须 |
| `src/config.py` | 标记废弃 | ⚪ 可选 |

**无需修改的文件**：
- `api/server.py` - API 语义不变
- `src/agent_manager.py` - 调用方式不变
- `src/webdav.py` - 已是用户级目录

---

## 二、`src/docker_sandbox.py` 修改

### 2.1 修改点1：工作目录去掉 thread_id (第30-46行)

```python
# ============ 修改前 ============
def get_thread_backend(thread_id: str) -> 'DockerSandboxBackend':
    """Get or create a thread backend.
    
    Workspace directory structure: workspaces/{user_id}/{thread_id}/
    """
    if thread_id not in _thread_backends:
        user_id = thread_id.split('-')[0]
        
        workspace_dir = os.path.join(
            Path(settings.WORKSPACE_ROOT).expanduser().absolute(),
            user_id,
            thread_id  # <-- 删除这行
        )
        os.makedirs(workspace_dir, exist_ok=True)
        _thread_backends[thread_id] = DockerSandboxBackend(thread_id, workspace_dir)
    return _thread_backends[thread_id]


# ============ 修改后 ============
def get_thread_backend(thread_id: str) -> 'DockerSandboxBackend':
    """Get or create a thread backend.
    
    Workspace directory structure: workspaces/{user_id}/
    All threads of the same user share the same workspace directory.
    """
    if thread_id not in _thread_backends:
        user_id = thread_id.split('-')[0]
        
        workspace_dir = os.path.join(
            Path(settings.WORKSPACE_ROOT).expanduser().absolute(),
            user_id
        )
        os.makedirs(workspace_dir, exist_ok=True)
        _thread_backends[thread_id] = DockerSandboxBackend(thread_id, workspace_dir)
    return _thread_backends[thread_id]
```

### 2.2 修改点2：移除 /user_shared 挂载 (第167-203行)

```python
# ============ 修改前 ============
def _create_container(self) -> docker.models.containers.Container:
    """Create a new container."""
    user_id = self.thread_id.split('-')[0]
    
    # User-level shared directory
    user_shared_dir = os.path.join(
        Path(settings.WORKSPACE_ROOT).expanduser().absolute(),
        user_id,
        "shared"
    )
    os.makedirs(user_shared_dir, exist_ok=True)
    
    # Global shared directory
    shared_dir = str(Path(settings.SHARED_DIR).expanduser().absolute())
    os.makedirs(shared_dir, exist_ok=True)
    
    skills_dir = os.path.join(shared_dir, "skills")
    os.makedirs(skills_dir, exist_ok=True)
    
    return self.client.containers.create(
        image=self.image,
        command="sleep infinity",
        working_dir=settings.CONTAINER_WORKSPACE_DIR,
        volumes={
            _to_docker_path(self.workspace_dir): {"bind": settings.CONTAINER_WORKSPACE_DIR, "mode": "rw"},
            _to_docker_path(user_shared_dir): {"bind": settings.USER_SHARED, "mode": "rw"},
            _to_docker_path(shared_dir): {"bind": settings.CONTAINER_SHARED_DIR, "mode": "ro"},
            _to_docker_path(skills_dir): {"bind": settings.CONTAINER_SKILLS_DIR, "mode": "ro"}
        }
    )


# ============ 修改后 ============
def _create_container(self) -> docker.models.containers.Container:
    """Create a new container.
    
    Mounts:
    - /workspace: User-level workspace (rw) - shared by all user's threads
    - /shared: Global shared directory (ro)
    - /skills: Global skills directory (ro)
    """
    user_id = self.thread_id.split('-')[0]
    
    shared_dir = str(Path(settings.SHARED_DIR).expanduser().absolute())
    os.makedirs(shared_dir, exist_ok=True)
    
    skills_dir = os.path.join(shared_dir, "skills")
    os.makedirs(skills_dir, exist_ok=True)
    
    return self.client.containers.create(
        image=self.image,
        command="sleep infinity",
        working_dir=settings.CONTAINER_WORKSPACE_DIR,
        volumes={
            _to_docker_path(self.workspace_dir): {"bind": settings.CONTAINER_WORKSPACE_DIR, "mode": "rw"},
            _to_docker_path(shared_dir): {"bind": settings.CONTAINER_SHARED_DIR, "mode": "ro"},
            _to_docker_path(skills_dir): {"bind": settings.CONTAINER_SKILLS_DIR, "mode": "ro"}
        }
    )
```

### 2.3 Diff 汇总

| 行号 | 修改类型 | 说明 |
|------|----------|------|
| 33 | 注释更新 | 目录结构 `workspaces/{user_id}/{thread_id}/` → `workspaces/{user_id}/` |
| 42 | 删除 | 移除 `thread_id` 层级 |
| 171-177 | 注释更新 | 更新挂载说明 |
| 178-183 | 删除 | 移除 `user_shared_dir` 创建代码 |
| 199 | 删除 | 移除 `/user_shared` 挂载 |

---

## 三、`tests/test_container_persistence.py` 修改

### 3.1 测试1：`test_user_shared_directory` → `test_workspace_shared`

```python
# ============ 修改前 ============
def test_user_shared_directory():
    """Test that same user's threads can share files via /user_shared."""
    thread_id_1 = "shareduser-sharing-001"
    thread_id_2 = "shareduser-sharing-002"
    
    try:
        backend1 = get_thread_backend(thread_id_1)
        backend2 = get_thread_backend(thread_id_2)
        
        result1 = backend1.execute("echo 'shared data' > /user_shared/test.txt")
        assert result1.exit_code == 0
        
        result2 = backend2.execute("cat /user_shared/test.txt")
        assert result2.exit_code == 0
        assert "shared data" in result2.output
        
        print("[PASS] test_user_shared_directory")
        
    finally:
        destroy_thread_backend(thread_id_1)
        destroy_thread_backend(thread_id_2)


# ============ 修改后 ============
def test_workspace_shared():
    """Test that same user's threads share the same /workspace directory."""
    thread_id_1 = "shareduser-sharing-001"
    thread_id_2 = "shareduser-sharing-002"
    
    try:
        backend1 = get_thread_backend(thread_id_1)
        backend2 = get_thread_backend(thread_id_2)
        
        result1 = backend1.execute("echo 'shared data' > /workspace/test.txt")
        assert result1.exit_code == 0, f"write failed: {result1.output}"
        
        result2 = backend2.execute("cat /workspace/test.txt")
        assert result2.exit_code == 0, f"read failed: {result2.output}"
        assert "shared data" in result2.output, f"Content not found: {result2.output}"
        
        print("[PASS] test_workspace_shared")
        
    finally:
        destroy_thread_backend(thread_id_1)
        destroy_thread_backend(thread_id_2)
```

### 3.2 测试2：`test_user_shared_isolation` → `test_workspace_isolation`

```python
# ============ 修改前 ============
def test_user_shared_isolation():
    """Test that different users cannot see each other's shared files."""
    thread_id_a = "userA-isolation-001"
    thread_id_b = "userB-isolation-001"
    
    try:
        backend_a = get_thread_backend(thread_id_a)
        backend_b = get_thread_backend(thread_id_b)
        
        backend_a.execute("echo 'userA secret' > /user_shared/a.txt")
        backend_b.execute("echo 'userB secret' > /user_shared/b.txt")
        
        result = backend_b.execute("cat /user_shared/a.txt 2>&1 || echo 'NOT_FOUND'")
        assert "userA secret" not in result.output
        
        print("[PASS] test_user_shared_isolation")
        
    finally:
        destroy_thread_backend(thread_id_a)
        destroy_thread_backend(thread_id_b)


# ============ 修改后 ============
def test_workspace_isolation():
    """Test that different users have isolated /workspace directories."""
    thread_id_a = "userA-isolation-001"
    thread_id_b = "userB-isolation-001"
    
    try:
        backend_a = get_thread_backend(thread_id_a)
        backend_b = get_thread_backend(thread_id_b)
        
        backend_a.execute("echo 'userA secret' > /workspace/a.txt")
        backend_b.execute("echo 'userB secret' > /workspace/b.txt")
        
        result_b = backend_b.execute("cat /workspace/a.txt 2>&1 || echo 'NOT_FOUND'")
        assert "userA secret" not in result_b.output, f"userB should not see userA's file"
        
        result_a = backend_a.execute("cat /workspace/b.txt 2>&1 || echo 'NOT_FOUND'")
        assert "userB secret" not in result_a.output, f"userA should not see userB's file"
        
        print("[PASS] test_workspace_isolation")
        
    finally:
        destroy_thread_backend(thread_id_a)
        destroy_thread_backend(thread_id_b)
```

### 3.3 主函数更新

```python
if __name__ == "__main__":
    # ...
    test_workspace_shared()      # 改名
    test_workspace_isolation()   # 改名
    # ...
```

---

## 四、`src/config.py` 可选修改

标记 `USER_SHARED` 为废弃（或直接保留不改动）：

```python
# 选项：添加注释标记废弃
USER_SHARED: str  # @deprecated - v0.1.6 后不再使用，/workspace 已改为用户级
```

---

## 五、验证命令

```bash
# 运行容器测试
uv run python tests/test_container_persistence.py

# 运行完整测试
run_tests.bat
```

### 预期输出

```
[PASS] test_container_persistence
[PASS] test_container_reuse
[PASS] test_destroy_session
[PASS] test_destroy_idempotent
[PASS] test_file_persistence
[PASS] test_workspace_shared
[PASS] test_workspace_isolation
All tests passed!
```
